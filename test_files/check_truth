' ============================================================
' Скрипт валидации расчетной модели RastrWin3
' Проверка таблиц: Узлы, Ветви, Генераторы
' ============================================================

Sub Main()
    ' ОТЛАДКА: Временно отключаем подавление ошибок
    ' On Error Resume Next
    
    Dim errors, warnings
    Dim errorCount, warnCount
    Dim errNum
    Dim tNode, tVetv, tGen
    
    ' === ДИАГНОСТИКА ===
    MsgBox "Скрипт запущен!", vbInformation, "Диагностика"
    
    ' Проверяем доступность таблиц
    Set tNode = Rastr.Tables("node")
    If tNode Is Nothing Then
        MsgBox "Таблица 'node' не найдена!", vbCritical, "Ошибка"
    Else
        MsgBox "Таблица 'node' OK. Записей: " & tNode.Count, vbInformation, "Диагностика"
    End If
    
    Set tVetv = Rastr.Tables("vetv")
    If tVetv Is Nothing Then
        MsgBox "Таблица 'vetv' не найдена!", vbCritical, "Ошибка"
    Else
        MsgBox "Таблица 'vetv' OK. Записей: " & tVetv.Count, vbInformation, "Диагностика"
    End If
    
    Set tGen = Rastr.Tables("Generator")
    If tGen Is Nothing Then
        MsgBox "Таблица 'Generator' не найдена (это нормально если нет генераторов)", vbExclamation, "Предупреждение"
    Else
        MsgBox "Таблица 'Generator' OK. Записей: " & tGen.Count, vbInformation, "Диагностика"
    End If
    ' === КОНЕЦ ДИАГНОСТИКИ ===
    
    errors = ""
    warnings = ""
    errorCount = 0
    warnCount = 0
    
    ' Проверка узлов
    Call CheckNodes(errors, warnings, errorCount, warnCount)
    
    ' Проверка ветвей
    Call CheckBranches(errors, warnings, errorCount, warnCount)
    
    ' Проверка генераторов
    Call CheckGenerators(errors, warnings, errorCount, warnCount)
    
    ' Проверка топологии
    Call CheckTopology(errors, warnings, errorCount, warnCount)
    
    ' Вывод отчета
    Call PrintReport(errors, warnings, errorCount, warnCount)
    
    On Error GoTo 0
End Sub

' ============================================================
' Проверка таблицы УЗЛЫ
' ============================================================
Sub CheckNodes(errors, warnings, errorCount, warnCount)
    On Error Resume Next
    
    Dim t, tGen, i, j, ny, uhom, vzd, pn, qn, nodeName, tgPhi
    Dim hasGenerator
    
    Set t = Rastr.Tables("node")
    Set tGen = Rastr.Tables("Generator")
    If t Is Nothing Then Exit Sub
    
    For i = 0 To t.Count - 1
        ny = t.Cols("ny").Z(i)
        nodeName = t.Cols("name").Z(i)
        uhom = t.Cols("uhom").Z(i)
        vzd = t.Cols("vzd").Z(i)
        pn = t.Cols("pn").Z(i)
        qn = t.Cols("qn").Z(i)
        
        ' Проверка 1: Стандартные классы напряжения
        If uhom <> 0.4 And uhom <> 6 And uhom <> 10 And uhom <> 35 And _
           uhom <> 110 And uhom <> 220 And uhom <> 330 And uhom <> 500 And _
           uhom <> 750 And uhom <> 1150 Then
            errors = errors & "Узел " & ny & " (" & nodeName & "): " & _
                    "Нестандартное Uном = " & uhom & " кВ" & vbCrLf
            errorCount = errorCount + 1
        End If
        
        ' Проверка 2: Напряжение в допустимых пределах
        If vzd < 0.9 Or vzd > 1.15 Then
            warnings = warnings & "Узел " & ny & " (" & nodeName & "): " & _
                      "Напряжение " & Round(vzd, 3) & " о.е. вне нормы" & vbCrLf
            warnCount = warnCount + 1
        End If
        
        ' Проверка 3: Подозрительный tgφ
        ' Сначала проверяем - есть ли генератор в этом узле (может быть СК)
        hasGenerator = False
        If Not tGen Is Nothing Then
            For j = 0 To tGen.Count - 1
                If tGen.Cols("Node").Z(j) = ny Then
                    hasGenerator = True
                    Exit For
                End If
            Next
        End If
        
        ' Проверяем tgφ только если НЕТ генератора (иначе может быть СК на ХХ)
        If Not hasGenerator And Abs(pn) > 0.01 Then
            tgPhi = Abs(qn / pn)
            If tgPhi > 2.0 Then
                warnings = warnings & "Узел " & ny & " (" & nodeName & "): " & _
                          "Подозрительный tgφ = " & Round(tgPhi, 2) & " (нет генератора)" & vbCrLf
                warnCount = warnCount + 1
            End If
        End If
        
        ' Проверка 4: Отрицательное напряжение
        If vzd < 0 Then
            errors = errors & "Узел " & ny & " (" & nodeName & "): " & _
                    "Отрицательное напряжение!" & vbCrLf
            errorCount = errorCount + 1
        End If
    Next
    
    On Error GoTo 0
End Sub

' ============================================================
' Проверка таблицы ВЕТВИ
' ============================================================
Sub CheckBranches(errors, warnings, errorCount, warnCount)
    On Error Resume Next
    
    Dim t, i, ip, iq, r, x, ktr, sta, rxRatio
    
    Set t = Rastr.Tables("vetv")
    If t Is Nothing Then Exit Sub
    
    For i = 0 To t.Count - 1
        ip = t.Cols("ip").Z(i)
        iq = t.Cols("iq").Z(i)
        r = t.Cols("r").Z(i)
        x = t.Cols("x").Z(i)
        ktr = t.Cols("ktr").Z(i)
        sta = t.Cols("sta").Z(i)
        
        ' Проверка 1: Нулевое сопротивление
        If r = 0 And x = 0 Then
            errors = errors & "Ветвь " & ip & "-" & iq & ": " & _
                    "Нулевое сопротивление (r=0, x=0)" & vbCrLf
            errorCount = errorCount + 1
        End If
        
        ' Проверка 2: Отрицательное активное сопротивление - ОШИБКА
        If r < 0 Then
            errors = errors & "Ветвь " & ip & "-" & iq & ": " & _
                    "Отрицательное активное R = " & r & vbCrLf
            errorCount = errorCount + 1
        End If
        
        ' Проверка 2.1: Отрицательное реактивное - ПРЕДУПРЕЖДЕНИЕ (может быть СН трансформатора)
        If x < 0 Then
            warnings = warnings & "Ветвь " & ip & "-" & iq & ": " & _
                    "Отрицательное X = " & x & " (СН трансформатора?)" & vbCrLf
            warnCount = warnCount + 1
        End If
        
        ' Проверка 3: Соотношение R/X для ЛЭП
        If ktr = 0 And x <> 0 Then
            rxRatio = r / x
            If rxRatio > 1.0 Then
                warnings = warnings & "Ветвь " & ip & "-" & iq & ": " & _
                          "Высокое R/X = " & Round(rxRatio, 2) & vbCrLf
                warnCount = warnCount + 1
            End If
        End If
        
        ' Проверка 4: Коэффициент трансформации
        If ktr <> 0 And (ktr < 0.8 Or ktr > 1.2) Then
            warnings = warnings & "Ветвь " & ip & "-" & iq & ": " & _
                      "Необычный Kтр = " & Round(ktr, 3) & vbCrLf
            warnCount = warnCount + 1
        End If
        
        ' Проверка 5: Ветвь замкнута сама на себя
        If ip = iq Then
            errors = errors & "Ветвь " & ip & "-" & iq & ": " & _
                    "Замкнута сама на себя" & vbCrLf
            errorCount = errorCount + 1
        End If
        
        ' Проверка 6: Очень большое сопротивление
        If x > 1000 Then
            warnings = warnings & "Ветвь " & ip & "-" & iq & ": " & _
                      "Очень большое X = " & Round(x, 1) & vbCrLf
            warnCount = warnCount + 1
        End If
    Next
    
    On Error GoTo 0
End Sub

' ============================================================
' Проверка таблицы ГЕНЕРАТОРЫ
' ============================================================
Sub CheckGenerators(errors, warnings, errorCount, warnCount)
    On Error Resume Next
    
    Dim t, i, node, pgen, qgen, qmin, qmax, pnom, genName
    
    Set t = Rastr.Tables("Generator")
    If t Is Nothing Then Exit Sub
    
    For i = 0 To t.Count - 1
        node = t.Cols("Node").Z(i)
        genName = t.Cols("Name").Z(i)
        pgen = t.Cols("P").Z(i)
        qgen = t.Cols("Q").Z(i)
        qmin = t.Cols("Qmin").Z(i)
        qmax = t.Cols("Qmax").Z(i)
        pnom = t.Cols("Pnom").Z(i)
        
        ' Проверка 1: Генерация больше номинала
        If pnom > 0 And pgen > pnom * 1.1 Then
            warnings = warnings & "Ген. в узле " & node & " (" & genName & "): " & _
                      "P=" & Round(pgen, 1) & " > Pном=" & Round(pnom, 1) & vbCrLf
            warnCount = warnCount + 1
        End If
        
        ' Проверка 2: Q вне пределов
        If qgen < qmin - 0.01 Or qgen > qmax + 0.01 Then
            warnings = warnings & "Ген. в узле " & node & " (" & genName & "): " & _
                      "Q=" & Round(qgen, 1) & " вне [" & qmin & ", " & qmax & "]" & vbCrLf
            warnCount = warnCount + 1
        End If
        
        ' Проверка 3: Qmin > Qmax
        If qmin > qmax Then
            errors = errors & "Ген. в узле " & node & " (" & genName & "): " & _
                    "Qmin=" & qmin & " > Qmax=" & qmax & vbCrLf
            errorCount = errorCount + 1
        End If
        
        ' Проверка 4: Отрицательная генерация
        If pgen < -0.1 Then
            warnings = warnings & "Ген. в узле " & node & " (" & genName & "): " & _
                      "Отрицательная P=" & Round(pgen, 1) & " (двигатель?)" & vbCrLf
            warnCount = warnCount + 1
        End If
        
        ' Проверка 5: Нулевой номинал
        If pnom = 0 Then
            warnings = warnings & "Ген. в узле " & node & " (" & genName & "): " & _
                      "Нулевая номинальная мощность" & vbCrLf
            warnCount = warnCount + 1
        End If
    Next
    
    On Error GoTo 0
End Sub

' ============================================================
' Проверка топологии
' ============================================================
Sub CheckTopology(errors, warnings, errorCount, warnCount)
    On Error Resume Next
    
    Dim tNode, tVetv, i, j, ny, ip, iq, sta, isConnected, nodeName
    
    Set tNode = Rastr.Tables("node")
    Set tVetv = Rastr.Tables("vetv")
    If tNode Is Nothing Or tVetv Is Nothing Then Exit Sub
    
    For i = 0 To tNode.Count - 1
        ny = tNode.Cols("ny").Z(i)
        nodeName = tNode.Cols("name").Z(i)
        
        isConnected = False
        
        For j = 0 To tVetv.Count - 1
            ip = tVetv.Cols("ip").Z(j)
            iq = tVetv.Cols("iq").Z(j)
            sta = tVetv.Cols("sta").Z(j)
            
            If sta = 0 And (ip = ny Or iq = ny) Then
                isConnected = True
                Exit For
            End If
        Next
        
        If Not isConnected Then
            warnings = warnings & "Узел " & ny & " (" & nodeName & "): " & _
                      "Изолирован (нет подключенных ветвей)" & vbCrLf
            warnCount = warnCount + 1
        End If
    Next
    
    On Error GoTo 0
End Sub

' ============================================================
' Экспорт отчета в Excel
' ============================================================
Sub PrintReport(errors, warnings, errorCount, warnCount)
    On Error Resume Next
    
    Dim xlApp, xlBook, xlSheet
    Dim errArr, warnArr
    Dim i, row
    Dim filePath
    
    filePath = "d:\PycharmProjects\test_model\validation_report.xlsx"
    
    ' Создаем Excel
    Set xlApp = CreateObject("Excel.Application")
    If xlApp Is Nothing Then
        MsgBox "Не удалось создать Excel! Проверьте установку MS Office.", vbCritical, "Ошибка"
        Exit Sub
    End If
    
    Set xlBook = xlApp.Workbooks.Add
    Set xlSheet = xlBook.Sheets(1)
    xlSheet.Name = "Отчет валидации"
    
    ' Заголовки
    xlSheet.Cells(1, 1).Value = "Тип"
    xlSheet.Cells(1, 2).Value = "Сообщение"
    xlSheet.Cells(1, 3).Value = "Дата проверки"
    
    ' Форматирование заголовков
    xlSheet.Range("A1:C1").Font.Bold = True
    xlSheet.Range("A1:C1").Interior.Color = RGB(200, 200, 200)
    
    row = 2
    
    ' Записываем ошибки
    If Len(errors) > 0 Then
        errArr = Split(errors, vbCrLf)
        For i = 0 To UBound(errArr)
            If Len(Trim(errArr(i))) > 0 Then
                xlSheet.Cells(row, 1).Value = "ОШИБКА"
                xlSheet.Cells(row, 1).Font.Color = RGB(255, 0, 0)
                xlSheet.Cells(row, 2).Value = errArr(i)
                xlSheet.Cells(row, 3).Value = Now()
                row = row + 1
            End If
        Next
    End If
    
    ' Записываем предупреждения
    If Len(warnings) > 0 Then
        warnArr = Split(warnings, vbCrLf)
        For i = 0 To UBound(warnArr)
            If Len(Trim(warnArr(i))) > 0 Then
                xlSheet.Cells(row, 1).Value = "ПРЕДУПРЕЖДЕНИЕ"
                xlSheet.Cells(row, 1).Font.Color = RGB(255, 165, 0)
                xlSheet.Cells(row, 2).Value = warnArr(i)
                xlSheet.Cells(row, 3).Value = Now()
                row = row + 1
            End If
        Next
    End If
    
    ' Если нет ошибок
    If errorCount = 0 And warnCount = 0 Then
        xlSheet.Cells(2, 1).Value = "OK"
        xlSheet.Cells(2, 1).Font.Color = RGB(0, 128, 0)
        xlSheet.Cells(2, 2).Value = "Ошибок и предупреждений не обнаружено"
        xlSheet.Cells(2, 3).Value = Now()
    End If
    
    ' Автоширина колонок
    xlSheet.Columns("A:C").AutoFit
    
    ' Сохраняем и показываем
    xlBook.SaveAs filePath
    xlApp.Visible = True
    
    MsgBox "Отчет сохранен: " & filePath & vbCrLf & _
           "Ошибок: " & errorCount & vbCrLf & _
           "Предупреждений: " & warnCount, vbInformation, "Готово"
    
    On Error GoTo 0
End Sub

' ============================================================
' ЗАПУСК СКРИПТА
' ============================================================
Call Main()
