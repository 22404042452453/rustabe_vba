' ============================================================
' Скрипт валидации расчетной модели RastrWin3
' Проверка таблиц: Узлы, Ветви, Генераторы
' ============================================================

Sub Main()
    ' ОТЛАДКА: Временно отключаем подавление ошибок
    ' On Error Resume Next
    
    Dim errors, warnings
    Dim errorCount, warnCount
    Dim errNum
    Dim tNode, tVetv, tGen
    
    ' === ДИАГНОСТИКА ===
    MsgBox "Скрипт запущен!", vbInformation, "Диагностика"
    
    ' Проверяем доступность таблиц
    Set tNode = Rastr.Tables("node")
    If tNode Is Nothing Then
        MsgBox "Таблица 'node' не найдена!", vbCritical, "Ошибка"
    Else
        MsgBox "Таблица 'node' OK. Записей: " & tNode.Count, vbInformation, "Диагностика"
    End If
    
    Set tVetv = Rastr.Tables("vetv")
    If tVetv Is Nothing Then
        MsgBox "Таблица 'vetv' не найдена!", vbCritical, "Ошибка"
    Else
        MsgBox "Таблица 'vetv' OK. Записей: " & tVetv.Count, vbInformation, "Диагностика"
    End If
    
    Set tGen = Rastr.Tables("Generator")
    If tGen Is Nothing Then
        MsgBox "Таблица 'Generator' не найдена (это нормально если нет генераторов)", vbExclamation, "Предупреждение"
    Else
        MsgBox "Таблица 'Generator' OK. Записей: " & tGen.Count, vbInformation, "Диагностика"
    End If
    ' === КОНЕЦ ДИАГНОСТИКИ ===
    
    ' Переменные для сбора ошибок по категориям
    Dim errNodes, warnNodes, errBranches, warnBranches
    Dim errGens, warnGens, errTopo, warnTopo
    Dim cntErrNodes, cntWarnNodes, cntErrBranches, cntWarnBranches
    Dim cntErrGens, cntWarnGens, cntErrTopo, cntWarnTopo
    
    errNodes = "": warnNodes = "": cntErrNodes = 0: cntWarnNodes = 0
    errBranches = "": warnBranches = "": cntErrBranches = 0: cntWarnBranches = 0
    errGens = "": warnGens = "": cntErrGens = 0: cntWarnGens = 0
    errTopo = "": warnTopo = "": cntErrTopo = 0: cntWarnTopo = 0
    
    ' Проверка узлов
    Call CheckNodes(errNodes, warnNodes, cntErrNodes, cntWarnNodes)
    
    ' Проверка ветвей
    Call CheckBranches(errBranches, warnBranches, cntErrBranches, cntWarnBranches)
    
    ' Проверка генераторов
    Call CheckGenerators(errGens, warnGens, cntErrGens, cntWarnGens)
    
    ' Проверка топологии
    Call CheckTopology(errTopo, warnTopo, cntErrTopo, cntWarnTopo)
    
    ' Вывод отчета с разбивкой по вкладкам
    Call PrintReportMultiSheet(errNodes, warnNodes, cntErrNodes, cntWarnNodes, _
                               errBranches, warnBranches, cntErrBranches, cntWarnBranches, _
                               errGens, warnGens, cntErrGens, cntWarnGens, _
                               errTopo, warnTopo, cntErrTopo, cntWarnTopo)
    
    On Error GoTo 0
End Sub

' ============================================================
' Проверка таблицы УЗЛЫ
' ============================================================
Sub CheckNodes(errors, warnings, errorCount, warnCount)
    On Error Resume Next
    
    Dim t, tGen, i, j, ny, uhom, vzd, vras, vras_oe, pn, qn, nodeName, tgPhi
    Dim hasGenerator
    
    Set t = Rastr.Tables("node")
    Set tGen = Rastr.Tables("Generator")
    If t Is Nothing Then Exit Sub
    
    For i = 0 To t.Count - 1
        ny = t.Cols("ny").Z(i)
        nodeName = t.Cols("name").Z(i)
        uhom = t.Cols("uhom").Z(i)
        vzd = t.Cols("vzd").Z(i)
        vras = t.Cols("vras").Z(i)
        pn = t.Cols("pn").Z(i)
        qn = t.Cols("qn").Z(i)
        
        ' Сначала определяем - есть ли генератор в этом узле
        hasGenerator = False
        If Not tGen Is Nothing Then
            For j = 0 To tGen.Count - 1
                If tGen.Cols("Node").Z(j) = ny Then
                    hasGenerator = True
                    Exit For
                End If
            Next
        End If
        
        ' Проверка 1: Стандартные классы напряжения
        If uhom <> 0.4 And uhom <> 6 And uhom <> 10 And uhom <> 35 And _
           uhom <> 110 And uhom <> 220 And uhom <> 330 And uhom <> 500 And _
           uhom <> 750 And uhom <> 1150 Then
            errors = errors & "Узел " & ny & " (" & nodeName & "): " & _
                    "Нестандартное Uном = " & uhom & " кВ" & vbCrLf
            errorCount = errorCount + 1
        End If
        
        ' Проверка 2: Заданное напряжение vzd - ТОЛЬКО для узлов с генератором
        If hasGenerator Then
            If vzd < 0.9 Or vzd > 1.1 Then
                errors = errors & "Узел " & ny & " (" & nodeName & "): " & _
                        "Uзд = " & Round(vzd, 3) & " о.е. вне пределов [0.9; 1.1]" & vbCrLf
                errorCount = errorCount + 1
            ElseIf vzd < 0.95 Or vzd > 1.05 Then
                warnings = warnings & "Узел " & ny & " (" & nodeName & "): " & _
                          "Uзд = " & Round(vzd, 3) & " о.е. близко к пределу" & vbCrLf
                warnCount = warnCount + 1
            End If
        End If
        
        ' Проверка 2.1: Расчётное напряжение vras - для ВСЕХ узлов
        If uhom > 0 Then
            vras_oe = vras / uhom   ' Переводим в о.е.
            If vras_oe < 0.9 Or vras_oe > 1.1 Then
                errors = errors & "Узел " & ny & " (" & nodeName & "): " & _
                        "Uрас = " & Round(vras, 1) & " кВ (" & Round(vras_oe, 3) & " о.е.) вне пределов [0.9; 1.1]" & vbCrLf
                errorCount = errorCount + 1
            ElseIf vras_oe < 0.95 Or vras_oe > 1.05 Then
                warnings = warnings & "Узел " & ny & " (" & nodeName & "): " & _
                          "Uрас = " & Round(vras, 1) & " кВ (" & Round(vras_oe, 3) & " о.е.) близко к пределу" & vbCrLf
                warnCount = warnCount + 1
            End If
        End If
        
        ' Проверка 3: Подозрительный tgφ (только для нагрузочных узлов)
        
        ' Проверяем tgφ только если НЕТ генератора (иначе может быть СК на ХХ)
        If Not hasGenerator And Abs(pn) > 0.01 Then
            tgPhi = Abs(qn / pn)
            If tgPhi > 2.0 Then
                warnings = warnings & "Узел " & ny & " (" & nodeName & "): " & _
                          "Подозрительный tgφ = " & Round(tgPhi, 2) & " (нет генератора)" & vbCrLf
                warnCount = warnCount + 1
            End If
        End If
        
        ' Проверка 4: Отрицательное напряжение
        If vzd < 0 Then
            errors = errors & "Узел " & ny & " (" & nodeName & "): " & _
                    "Отрицательное напряжение!" & vbCrLf
            errorCount = errorCount + 1
        End If
    Next
    
    On Error GoTo 0
End Sub

' ============================================================
' Проверка таблицы ВЕТВИ
' ============================================================
Sub CheckBranches(errors, warnings, errorCount, warnCount)
    On Error Resume Next
    
    Dim t, i, ip, iq, r, x, ktr, sta, rxRatio
    
    Set t = Rastr.Tables("vetv")
    If t Is Nothing Then Exit Sub
    
    For i = 0 To t.Count - 1
        ip = t.Cols("ip").Z(i)
        iq = t.Cols("iq").Z(i)
        r = t.Cols("r").Z(i)
        x = t.Cols("x").Z(i)
        ktr = t.Cols("ktr").Z(i)
        sta = t.Cols("sta").Z(i)
        
        ' Проверка 1: Нулевое сопротивление
        If r = 0 And x = 0 Then
            errors = errors & "Ветвь " & ip & "-" & iq & ": " & _
                    "Нулевое сопротивление (r=0, x=0)" & vbCrLf
            errorCount = errorCount + 1
        End If
        
        ' Проверка 2: Отрицательное активное сопротивление - ОШИБКА
        If r < 0 Then
            errors = errors & "Ветвь " & ip & "-" & iq & ": " & _
                    "Отрицательное активное R = " & r & vbCrLf
            errorCount = errorCount + 1
        End If
        
        ' Проверка 2.1: Отрицательное реактивное - ПРЕДУПРЕЖДЕНИЕ (может быть СН трансформатора)
        If x < 0 Then
            warnings = warnings & "Ветвь " & ip & "-" & iq & ": " & _
                    "Отрицательное X = " & x & " (СН трансформатора?)" & vbCrLf
            warnCount = warnCount + 1
        End If
        
        ' Проверка 3: Соотношение R/X для ЛЭП
        If ktr = 0 And x <> 0 Then
            rxRatio = r / x
            If rxRatio > 1.0 Then
                warnings = warnings & "Ветвь " & ip & "-" & iq & ": " & _
                          "Высокое R/X = " & Round(rxRatio, 2) & vbCrLf
                warnCount = warnCount + 1
            End If
        End If
        
        ' Проверка 4: Коэффициент трансформации
        If ktr <> 0 And (ktr < 0.8 Or ktr > 1.2) Then
            warnings = warnings & "Ветвь " & ip & "-" & iq & ": " & _
                      "Необычный Kтр = " & Round(ktr, 3) & vbCrLf
            warnCount = warnCount + 1
        End If
        
        ' Проверка 5: Ветвь замкнута сама на себя
        If ip = iq Then
            errors = errors & "Ветвь " & ip & "-" & iq & ": " & _
                    "Замкнута сама на себя" & vbCrLf
            errorCount = errorCount + 1
        End If
        
        ' Проверка 6: Очень большое сопротивление
        If x > 1000 Then
            warnings = warnings & "Ветвь " & ip & "-" & iq & ": " & _
                      "Очень большое X = " & Round(x, 1) & vbCrLf
            warnCount = warnCount + 1
        End If
    Next
    
    On Error GoTo 0
End Sub

' ============================================================
' Проверка таблицы ГЕНЕРАТОРЫ
' ============================================================
Sub CheckGenerators(errors, warnings, errorCount, warnCount)
    On Error Resume Next
    
    Dim t, i, node, pgen, qgen, qmin, qmax, pnom, genName
    
    Set t = Rastr.Tables("Generator")
    If t Is Nothing Then Exit Sub
    
    For i = 0 To t.Count - 1
        node = t.Cols("Node").Z(i)
        genName = t.Cols("Name").Z(i)
        pgen = t.Cols("P").Z(i)
        qgen = t.Cols("Q").Z(i)
        qmin = t.Cols("Qmin").Z(i)
        qmax = t.Cols("Qmax").Z(i)
        pnom = t.Cols("Pnom").Z(i)
        
        ' Проверка 1: Генерация больше номинала
        If pnom > 0 And pgen > pnom * 1.1 Then
            warnings = warnings & "Ген. в узле " & node & " (" & genName & "): " & _
                      "P=" & Round(pgen, 1) & " > Pном=" & Round(pnom, 1) & vbCrLf
            warnCount = warnCount + 1
        End If
        
        ' Проверка 2: Q вне пределов
        If qgen < qmin - 0.01 Or qgen > qmax + 0.01 Then
            warnings = warnings & "Ген. в узле " & node & " (" & genName & "): " & _
                      "Q=" & Round(qgen, 1) & " вне [" & qmin & ", " & qmax & "]" & vbCrLf
            warnCount = warnCount + 1
        End If
        
        ' Проверка 3: Qmin > Qmax
        If qmin > qmax Then
            errors = errors & "Ген. в узле " & node & " (" & genName & "): " & _
                    "Qmin=" & qmin & " > Qmax=" & qmax & vbCrLf
            errorCount = errorCount + 1
        End If
        
        ' Проверка 4: Отрицательная генерация
        If pgen < -0.1 Then
            warnings = warnings & "Ген. в узле " & node & " (" & genName & "): " & _
                      "Отрицательная P=" & Round(pgen, 1) & " (двигатель?)" & vbCrLf
            warnCount = warnCount + 1
        End If
        
        ' Проверка 5: Нулевой номинал
        If pnom = 0 Then
            warnings = warnings & "Ген. в узле " & node & " (" & genName & "): " & _
                      "Нулевая номинальная мощность" & vbCrLf
            warnCount = warnCount + 1
        End If
    Next
    
    On Error GoTo 0
End Sub

' ============================================================
' Проверка топологии
' ============================================================
Sub CheckTopology(errors, warnings, errorCount, warnCount)
    On Error Resume Next
    
    Dim tNode, tVetv, i, j, ny, ip, iq, sta, isConnected, nodeName
    
    Set tNode = Rastr.Tables("node")
    Set tVetv = Rastr.Tables("vetv")
    If tNode Is Nothing Or tVetv Is Nothing Then Exit Sub
    
    For i = 0 To tNode.Count - 1
        ny = tNode.Cols("ny").Z(i)
        nodeName = tNode.Cols("name").Z(i)
        
        isConnected = False
        
        For j = 0 To tVetv.Count - 1
            ip = tVetv.Cols("ip").Z(j)
            iq = tVetv.Cols("iq").Z(j)
            sta = tVetv.Cols("sta").Z(j)
            
            If sta = 0 And (ip = ny Or iq = ny) Then
                isConnected = True
                Exit For
            End If
        Next
        
        If Not isConnected Then
            warnings = warnings & "Узел " & ny & " (" & nodeName & "): " & _
                      "Изолирован (нет подключенных ветвей)" & vbCrLf
            warnCount = warnCount + 1
        End If
    Next
    
    On Error GoTo 0
End Sub

' ============================================================
' Экспорт отчета в Excel (много вкладок)
' ============================================================
Sub PrintReportMultiSheet(errNodes, warnNodes, cntErrNodes, cntWarnNodes, _
                          errBranches, warnBranches, cntErrBranches, cntWarnBranches, _
                          errGens, warnGens, cntErrGens, cntWarnGens, _
                          errTopo, warnTopo, cntErrTopo, cntWarnTopo)
    On Error Resume Next
    
    Dim xlApp, xlBook
    Dim shSummary, shNodes, shBranches, shGens, shTopo
    Dim filePath, totalErr, totalWarn
    
    filePath = "d:\PycharmProjects\test_model\validation_report.xlsx"
    totalErr = cntErrNodes + cntErrBranches + cntErrGens + cntErrTopo
    totalWarn = cntWarnNodes + cntWarnBranches + cntWarnGens + cntWarnTopo
    
    ' Создаем Excel
    Set xlApp = CreateObject("Excel.Application")
    If xlApp Is Nothing Then
        MsgBox "Не удалось создать Excel!", vbCritical, "Ошибка"
        Exit Sub
    End If
    
    Set xlBook = xlApp.Workbooks.Add
    
    ' Добавляем нужное количество листов (по умолчанию 3, нам надо 5)
    xlBook.Worksheets.Add
    xlBook.Worksheets.Add
    
    ' === ВКЛАДКА 1: СВОДКА ===
    Set shSummary = xlBook.Sheets(1)
    shSummary.Name = "Сводка"
    shSummary.Cells(1, 1).Value = "ОТЧЕТ О ВАЛИДАЦИИ МОДЕЛИ"
    shSummary.Cells(1, 1).Font.Bold = True
    shSummary.Cells(1, 1).Font.Size = 14
    shSummary.Cells(3, 1).Value = "Дата проверки:"
    shSummary.Cells(3, 2).Value = Now()
    shSummary.Cells(5, 1).Value = "Категория"
    shSummary.Cells(5, 2).Value = "Ошибки"
    shSummary.Cells(5, 3).Value = "Предупреждения"
    shSummary.Range("A5:C5").Font.Bold = True
    shSummary.Range("A5:C5").Interior.Color = RGB(200, 200, 200)
    shSummary.Cells(6, 1).Value = "Узлы"
    shSummary.Cells(6, 2).Value = cntErrNodes
    shSummary.Cells(6, 3).Value = cntWarnNodes
    shSummary.Cells(7, 1).Value = "Ветви"
    shSummary.Cells(7, 2).Value = cntErrBranches
    shSummary.Cells(7, 3).Value = cntWarnBranches
    shSummary.Cells(8, 1).Value = "Генераторы"
    shSummary.Cells(8, 2).Value = cntErrGens
    shSummary.Cells(8, 3).Value = cntWarnGens
    shSummary.Cells(9, 1).Value = "Топология"
    shSummary.Cells(9, 2).Value = cntErrTopo
    shSummary.Cells(9, 3).Value = cntWarnTopo
    shSummary.Cells(10, 1).Value = "ИТОГО"
    shSummary.Cells(10, 2).Value = totalErr
    shSummary.Cells(10, 3).Value = totalWarn
    shSummary.Range("A10:C10").Font.Bold = True
    shSummary.Columns("A:C").AutoFit
    
    ' === ВКЛАДКА 2: УЗЛЫ ===
    Set shNodes = xlBook.Sheets(2)
    shNodes.Name = "Узлы"
    Call FillSheet(shNodes, errNodes, warnNodes, cntErrNodes, cntWarnNodes)
    
    ' === ВКЛАДКА 3: ВЕТВИ ===
    Set shBranches = xlBook.Sheets(3)
    shBranches.Name = "Ветви"
    Call FillSheet(shBranches, errBranches, warnBranches, cntErrBranches, cntWarnBranches)
    
    ' === ВКЛАДКА 4: ГЕНЕРАТОРЫ ===
    Set shGens = xlBook.Sheets(4)
    shGens.Name = "Генераторы"
    Call FillSheet(shGens, errGens, warnGens, cntErrGens, cntWarnGens)
    
    ' === ВКЛАДКА 5: ТОПОЛОГИЯ ===
    Set shTopo = xlBook.Sheets(5)
    shTopo.Name = "Топология"
    Call FillSheet(shTopo, errTopo, warnTopo, cntErrTopo, cntWarnTopo)
    
    ' Активируем первую вкладку
    shSummary.Activate
    
    ' Сохраняем
    xlBook.SaveAs filePath
    xlApp.Visible = True
    
    MsgBox "Отчет сохранен: " & filePath & vbCrLf & _
           "Всего ошибок: " & totalErr & vbCrLf & _
           "Всего предупреждений: " & totalWarn, vbInformation, "Готово"
    
    On Error GoTo 0
End Sub

' ============================================================
' Вспомогательная функция заполнения листа
' ============================================================
Sub FillSheet(sheet, errors, warnings, errCount, warnCount)
    Dim arr, i, row
    
    sheet.Cells(1, 1).Value = "Тип"
    sheet.Cells(1, 2).Value = "Сообщение"
    sheet.Range("A1:B1").Font.Bold = True
    sheet.Range("A1:B1").Interior.Color = RGB(200, 200, 200)
    
    row = 2
    
    If Len(errors) > 0 Then
        arr = Split(errors, vbCrLf)
        For i = 0 To UBound(arr)
            If Len(Trim(arr(i))) > 0 Then
                sheet.Cells(row, 1).Value = "ОШИБКА"
                sheet.Cells(row, 1).Font.Color = RGB(255, 0, 0)
                sheet.Cells(row, 2).Value = arr(i)
                row = row + 1
            End If
        Next
    End If
    
    If Len(warnings) > 0 Then
        arr = Split(warnings, vbCrLf)
        For i = 0 To UBound(arr)
            If Len(Trim(arr(i))) > 0 Then
                sheet.Cells(row, 1).Value = "ПРЕДУПР."
                sheet.Cells(row, 1).Font.Color = RGB(255, 165, 0)
                sheet.Cells(row, 2).Value = arr(i)
                row = row + 1
            End If
        Next
    End If
    
    If errCount = 0 And warnCount = 0 Then
        sheet.Cells(2, 1).Value = "OK"
        sheet.Cells(2, 1).Font.Color = RGB(0, 128, 0)
        sheet.Cells(2, 2).Value = "Проблем не обнаружено"
    End If
    
    sheet.Columns("A:B").AutoFit
End Sub

' ============================================================
' Старая версия экспорта (не используется)
' ============================================================
Sub PrintReport(errors, warnings, errorCount, warnCount)
    On Error Resume Next
    
    Dim xlApp, xlBook, xlSheet
    Dim errArr, warnArr
    Dim i, row
    Dim filePath
    
    filePath = "d:\PycharmProjects\test_model\validation_report.xlsx"
    
    ' Создаем Excel
    Set xlApp = CreateObject("Excel.Application")
    If xlApp Is Nothing Then
        MsgBox "Не удалось создать Excel! Проверьте установку MS Office.", vbCritical, "Ошибка"
        Exit Sub
    End If
    
    Set xlBook = xlApp.Workbooks.Add
    Set xlSheet = xlBook.Sheets(1)
    xlSheet.Name = "Отчет валидации"
    
    ' Заголовки
    xlSheet.Cells(1, 1).Value = "Тип"
    xlSheet.Cells(1, 2).Value = "Сообщение"
    xlSheet.Cells(1, 3).Value = "Дата проверки"
    
    ' Форматирование заголовков
    xlSheet.Range("A1:C1").Font.Bold = True
    xlSheet.Range("A1:C1").Interior.Color = RGB(200, 200, 200)
    
    row = 2
    
    ' Записываем ошибки
    If Len(errors) > 0 Then
        errArr = Split(errors, vbCrLf)
        For i = 0 To UBound(errArr)
            If Len(Trim(errArr(i))) > 0 Then
                xlSheet.Cells(row, 1).Value = "ОШИБКА"
                xlSheet.Cells(row, 1).Font.Color = RGB(255, 0, 0)
                xlSheet.Cells(row, 2).Value = errArr(i)
                xlSheet.Cells(row, 3).Value = Now()
                row = row + 1
            End If
        Next
    End If
    
    ' Записываем предупреждения
    If Len(warnings) > 0 Then
        warnArr = Split(warnings, vbCrLf)
        For i = 0 To UBound(warnArr)
            If Len(Trim(warnArr(i))) > 0 Then
                xlSheet.Cells(row, 1).Value = "ПРЕДУПРЕЖДЕНИЕ"
                xlSheet.Cells(row, 1).Font.Color = RGB(255, 165, 0)
                xlSheet.Cells(row, 2).Value = warnArr(i)
                xlSheet.Cells(row, 3).Value = Now()
                row = row + 1
            End If
        Next
    End If
    
    ' Если нет ошибок
    If errorCount = 0 And warnCount = 0 Then
        xlSheet.Cells(2, 1).Value = "OK"
        xlSheet.Cells(2, 1).Font.Color = RGB(0, 128, 0)
        xlSheet.Cells(2, 2).Value = "Ошибок и предупреждений не обнаружено"
        xlSheet.Cells(2, 3).Value = Now()
    End If
    
    ' Автоширина колонок
    xlSheet.Columns("A:C").AutoFit
    
    ' Сохраняем и показываем
    xlBook.SaveAs filePath
    xlApp.Visible = True
    
    MsgBox "Отчет сохранен: " & filePath & vbCrLf & _
           "Ошибок: " & errorCount & vbCrLf & _
           "Предупреждений: " & warnCount, vbInformation, "Готово"
    
    On Error GoTo 0
End Sub

' ============================================================
' ЗАПУСК СКРИПТА
' ============================================================
Call Main()
