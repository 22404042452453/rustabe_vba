' --- Один модуль, без класса ---
Option Explicit

' Глобальные переменные для событий
Public ws As Worksheet
Public rowNum As Long

Sub CollectDynamicLogs()
    ' Инициализация Excel для результатов
    Dim wb As Workbook
    
    Set wb = Workbooks.Add
    Set ws = wb.Worksheets(1)
    ws.Name = "Логи"
    
    ' Заголовки
    ws.Cells(1, 1).Value = "№"
    ws.Cells(1, 2).Value = "Источник"
    ws.Cells(1, 3).Value = "Описание"
    ws.Range("A1:C1").Font.Bold = True
    
    rowNum = 2
    
    ' Создаем объект Rastr
    Dim Rastr As Object
    Set Rastr = CreateObject("Astra.Rastr")
    
    ' Загрузка файла (если нужно)
    ' Rastr.Load 1, "C:\путь\к\файлу.rg2", ""
    
    ' Получаем FWDynamic
    Dim spFWDynamic As Object
    Set spFWDynamic = Rastr.FWDynamic
    
    If Not spFWDynamic Is Nothing Then
        
        ' Вариант 1: Попробуем через свойство Rastr.Protocol
        On Error Resume Next
        Dim oldProtocol As String
        oldProtocol = Rastr.Protocol
        
        ' Запускаем расчет
        Debug.Print "Начало расчета..."
        Dim nRes As Long
        nRes = spFWDynamic.Run()
        
        If nRes = 0 Then
            Debug.Print "Расчет завершен"
            
            ' Получаем протокол после расчета
            Dim protocol As String
            protocol = Rastr.Protocol
            
            ' Разбиваем на строки
            Dim lines As Variant
            lines = Split(protocol, vbCrLf)
            If UBound(lines) = 0 Then lines = Split(protocol, vbLf)
            If UBound(lines) = 0 Then lines = Split(protocol, vbCr)
            
            ' Выгружаем в Excel
            Dim i As Long
            For i = 0 To UBound(lines)
                If Trim(lines(i)) <> "" Then
                    ws.Cells(rowNum, 1).Value = rowNum - 1
                    ws.Cells(rowNum, 2).Value = "Protocol"
                    ws.Cells(rowNum, 3).Value = Trim(lines(i))
                    rowNum = rowNum + 1
                End If
            Next i
            
            On Error GoTo 0
            
            ' Форматирование
            ws.Columns.AutoFit
            ws.Columns("C:C").ColumnWidth = 150
            
            Dim totalLines As Long
            totalLines = rowNum - 2
            MsgBox "Собрано логов: " & totalLines, vbInformation, "Готово"
        Else
            MsgBox "Ошибка расчета FWDynamic (код: " & nRes & ")", vbExclamation, "Ошибка"
        End If
    Else
        MsgBox "FWDynamic недоступен", vbCritical, "Ошибка"
    End If
End Sub
