' --- Сбор логов динамики в RastrWin ---

' Глобальные переменные
Dim xl, wb, ws
Dim rowNum

' Инициализация Excel
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
Set wb = xl.Workbooks.Add
Set ws = wb.Worksheets(1)
ws.Name = "Логи"

' Заголовки
ws.Cells(1, 1).Value = "№"
ws.Cells(1, 2).Value = "Источник"
ws.Cells(1, 3).Value = "Описание"
ws.Range("A1:C1").Font.Bold = True

rowNum = 2

' Запускаем расчет динамики (Rastr уже доступен глобально)
Dim spFWDynamic
Set spFWDynamic = Rastr.FWDynamic

If Not spFWDynamic Is Nothing Then
    Dim nRes
    nRes = spFWDynamic.Run()
    
    If nRes = 0 Then
        ' Получаем результирующее сообщение
        Dim resultMsg
        resultMsg = spFWDynamic.ResultMessage
        
        ' Разбиваем на строки
        Dim msgLines, i, logLine
        msgLines = Split(resultMsg, vbCrLf)
        If UBound(msgLines) = -1 Then
            msgLines = Split(resultMsg, vbLf)
        End If
        
        ' Записываем все логи в Excel
        For i = 0 To UBound(msgLines)
            logLine = Trim(msgLines(i))
            If Len(logLine) > 0 Then
                ws.Cells(rowNum, 1).Value = rowNum - 1
                ws.Cells(rowNum, 2).Value = "FWDynamic"
                ws.Cells(rowNum, 3).Value = logLine
                rowNum = rowNum + 1
            End If
        Next
        
        ' Форматирование
        ws.Columns.AutoFit
        ws.Columns("C:C").ColumnWidth = 150
        
        Dim totalLines
        totalLines = rowNum - 2
        MsgBox "Собрано логов: " & totalLines, vbInformation, "Готово"
    Else
        MsgBox "Ошибка расчета FWDynamic (код: " & nRes & ")", vbExclamation, "Ошибка"
    End If
Else
    MsgBox "FWDynamic недоступен", vbCritical, "Ошибка"
End If
