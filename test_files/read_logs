' --- Сбор логов во время расчета через события ---

' Инициализация Excel для результатов
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
Set wb = xl.Workbooks.Add
Set ws = wb.Worksheets(1)
ws.Name = "Логи"

' Заголовок
ws.Cells(1, 1).Value = "№"
ws.Cells(1, 2).Value = "Текст лога"
ws.Range("A1:B1").Font.Bold = True

' Глобальный счетчик для логов
Dim rowNum
rowNum = 2

' Получаем FWDynamic
Set spFWDynamic = Rastr.FWDynamic

If Not spFWDynamic Is Nothing Then
    
    ' Подписываемся на события (если есть)
    On Error Resume Next
    
    ' Пробуем разные варианты событий
    ' Вариант 1: OnLog
    WScript.ConnectObject spFWDynamic, "FWDynamic_"
    
    ' Запускаем расчет с периодическим опросом
    nRes = spFWDynamic.Run()
    
    On Error GoTo 0
    
    ' После расчета выводим финальное сообщение
    ws.Cells(rowNum, 1).Value = rowNum - 1
    ws.Cells(rowNum, 2).Value = spFWDynamic.ResultMessage
    
    ws.Columns.AutoFit
    
    totalLines = rowNum - 2
    MsgBox "Собрано логов: " & totalLines, vbInformation, "Готово"
Else
    MsgBox "FWDynamic недоступен", vbCritical, "Ошибка"
End If

' Обработчики событий
Sub FWDynamic_OnLog(message)
    ws.Cells(rowNum, 1).Value = rowNum - 1
    ws.Cells(rowNum, 2).Value = message
    rowNum = rowNum + 1
End Sub

Sub FWDynamic_OnMessage(message)
    ws.Cells(rowNum, 1).Value = rowNum - 1
    ws.Cells(rowNum, 2).Value = message
    rowNum = rowNum + 1
End Sub

Sub FWDynamic_OnEvent(message)
    ws.Cells(rowNum, 1).Value = rowNum - 1
    ws.Cells(rowNum, 2).Value = message
    rowNum = rowNum + 1
End Sub

Sub FWDynamic_OnProgress(message)
    ws.Cells(rowNum, 1).Value = rowNum - 1
    ws.Cells(rowNum, 2).Value = message
    rowNum = rowNum + 1
End Sub
