' --- Сбор логов во время расчета динамики ---

' Инициализация Excel для результатов
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
Set wb = xl.Workbooks.Add
Set ws = wb.Worksheets(1)
ws.Name = "Логи"

' Заголовок
ws.Cells(1, 1).Value = "№"
ws.Cells(1, 2).Value = "Текст лога"
ws.Range("A1:B1").Font.Bold = True

' Запускаем расчет динамики
Set spFWDynamic = Rastr.FWDynamic

If Not spFWDynamic Is Nothing Then
    
    ' Массив для сбора логов
    Dim logArray()
    ReDim logArray(1000) ' Начальный размер
    logCount = 0
    lastMessage = ""
    
    ' Запускаем расчет
    nRes = spFWDynamic.Run()
    
    ' Пробуем собрать логи после расчета через таблицы
    On Error Resume Next
    
    ' Проверяем таблицу Generator (генераторы)
    Set tblGen = Rastr.Tables("Generator")
    If Not tblGen Is Nothing Then
        ws.Cells(2, 1).Value = "Найдена таблица Generator, строк: " & tblGen.Size
    End If
    
    ' Проверяем таблицу Vetv (ветви/линии)
    Set tblVetv = Rastr.Tables("Vetv")
    If Not tblVetv Is Nothing Then
        ws.Cells(3, 1).Value = "Найдена таблица Vetv, строк: " & tblVetv.Size
    End If
    
    ' Проверяем таблицу Node (узлы)
    Set tblNode = Rastr.Tables("Node")
    If Not tblNode Is Nothing Then
        ws.Cells(4, 1).Value = "Найдена таблица Node, строк: " & tblNode.Size
    End If
    
    ' Может быть есть таблица с результатами расчета?
    Set tblResult = Rastr.Tables("Results")
    If tblResult Is Nothing Then Set tblResult = Rastr.Tables("CalcResults")
    If tblResult Is Nothing Then Set tblResult = Rastr.Tables("DynResults")
    
    If Not tblResult Is Nothing Then
        ws.Cells(5, 1).Value = "Найдена таблица Results, строк: " & tblResult.Size
        
        ' Пробуем извлечь данные
        For i = 0 To tblResult.Size - 1
            msg = ""
            ' Пробуем разные названия колонок
            msg = tblResult.Cols("message").Z(i)
            If msg = "" Then msg = tblResult.Cols("log").Z(i)
            If msg = "" Then msg = tblResult.Cols("text").Z(i)
            If msg = "" Then msg = tblResult.Cols("event").Z(i)
            
            If msg <> "" Then
                ws.Cells(6 + i, 1).Value = i + 1
                ws.Cells(6 + i, 2).Value = msg
            End If
        Next
    End If
    
    On Error GoTo 0
    
    ws.Columns.AutoFit
    
    MsgBox "Проверка таблиц завершена. Посмотрите какие таблицы найдены.", vbInformation, "Готово"
Else
    MsgBox "FWDynamic недоступен", vbCritical, "Ошибка"
End If
