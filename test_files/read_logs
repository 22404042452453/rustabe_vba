' --- Выгрузка логов ResultMessage в Excel ---

' Инициализация Excel для результатов
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
Set wb = xl.Workbooks.Add
Set ws = wb.Worksheets(1)
ws.Name = "Логи"

' Заголовок
ws.Cells(1, 1).Value = "№"
ws.Cells(1, 2).Value = "Текст лога"
ws.Range("A1:B1").Font.Bold = True

' Запускаем расчет динамики
Set spFWDynamic = Rastr.FWDynamic

If Not spFWDynamic Is Nothing Then
    nRes = spFWDynamic.Run()
    
    If nRes = 0 Then
        ' Получаем результирующее сообщение
        resultMsg = spFWDynamic.ResultMessage
        
        ' Выводим весь текст в одну ячейку для проверки
        ws.Cells(2, 3).Value = resultMsg
        
        ' Пробуем разные варианты разбиения
        msgLines = Split(resultMsg, Chr(13) & Chr(10)) ' vbCrLf
        If UBound(msgLines) <= 0 Then
            msgLines = Split(resultMsg, Chr(10)) ' vbLf
        End If
        If UBound(msgLines) <= 0 Then
            msgLines = Split(resultMsg, Chr(13)) ' vbCr
        End If

        ' Выгружаем все строки в Excel
        rowNum = 2
        For i = 0 To UBound(msgLines)
            ws.Cells(rowNum, 1).Value = i + 1
            ws.Cells(rowNum, 2).Value = msgLines(i)
            rowNum = rowNum + 1
        Next

        ' Форматирование
        ws.Columns("A:B").AutoFit
        
        ' Итоговое сообщение
        totalLines = UBound(msgLines) + 1
        MsgBox "Выгружено строк логов: " & totalLines & vbCrLf & "Весь текст в колонке C для проверки", vbInformation, "Выгрузка завершена"
    Else
        MsgBox "Ошибка расчета FWDynamic (код: " & nRes & ")", vbExclamation, "Ошибка"
    End If
Else
    MsgBox "FWDynamic недоступен", vbCritical, "Ошибка"
End If
