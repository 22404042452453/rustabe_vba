' В начале модуля объявить WithEvents
Dim WithEvents RastrObj As ASTRALib.Rastr
Dim ProtocolText As String

' Обработчик события prot
Private Sub RastrObj_prot(ByVal str As String)
    ProtocolText = ProtocolText & str & vbCrLf
End Sub

Sub TestRastrProtocol()
    Dim xl, wb, ws, lines, i
    
    ' Инициализация с событиями
    Set RastrObj = New ASTRALib.Rastr
    ProtocolText = ""
    
    ' Загрузка и расчет (протокол будет собираться автоматически)
    RastrObj.Load 1, "путь\к\файлу.rg2", "режим"
    RastrObj.rgm ""
    
    If Len(ProtocolText) = 0 Then
        MsgBox "Протокол пустой!"
        Exit Sub
    End If
    
    MsgBox "Длина: " & Len(ProtocolText)
    
    Set xl = CreateObject("Excel.Application")
    xl.Visible = True
    Set wb = xl.Workbooks.Add
    Set ws = wb.Worksheets(1)
    
    ws.Cells(1, 1).Value = "ПРОТОКОЛ:"
    ws.Cells(1, 1).Font.Bold = True
    ws.Cells(3, 1).Value = ProtocolText
    ws.Cells(3, 1).WrapText = True
    
    lines = Split(ProtocolText, vbCrLf)
    ws.Cells(5, 1).Value = "ПОСТРОЧНО:"
    ws.Cells(5, 1).Font.Bold = True
    
    For i = 0 To UBound(lines)
        If i < 50 Then
            ws.Cells(6 + i, 1).Value = i + 1
            ws.Cells(6 + i, 2).Value = lines(i)
        End If
    Next
    
    ws.Columns(2).ColumnWidth = 120
    MsgBox "Готово! Строк: " & (UBound(lines) + 1)
End Sub
