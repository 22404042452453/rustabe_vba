' --- Поиск логов блокировки фиксации АР через ResultMessage ---

' Инициализация Excel для результатов
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
Set wb = xl.Workbooks.Add
Set ws = wb.Worksheets(1)
ws.Name = "Блокировки АР"

' Заголовки
ws.Cells(1, 1).Value = "№"
ws.Cells(1, 2).Value = "Сценарий"
ws.Cells(1, 3).Value = "Полный текст лога"
ws.Cells(1, 4).Value = "Линия"
ws.Cells(1, 5).Value = "Параллельность"
ws.Cells(1, 6).Value = "Угол"
ws.Cells(1, 7).Value = "Порог"
ws.Cells(1, 8).Value = "Цикл АР"
ws.Cells(1, 9).Value = "Время (t)"
ws.Range("A1:I1").Font.Bold = True

' Счетчик строк результатов
rowNum = 2
foundTotal = 0

' Запускаем обычный расчет динамики (не EMS)
Set spFWDynamic = Rastr.FWDynamic

If Not spFWDynamic Is Nothing Then
    ' Обычный расчет динамики
    nRes = spFWDynamic.Run()
    
    If nRes = 0 Then
        ' Получаем результирующее сообщение
        resultMsg = spFWDynamic.ResultMessage
        
        ' Разбиваем на строки
        msgLines = Split(resultMsg, vbCrLf)
        If UBound(msgLines) = -1 Then
            msgLines = Split(resultMsg, vbLf)
        End If
        
        ' Обрабатываем каждую строку
        For i = 0 To UBound(msgLines)
            logLine = Trim(msgLines(i))
            
            ' Ищем строки с блокировкой АР или просто с превышением угла
            ' Варианты:
            ' 1. "Блокировка фиксации АР по изменению угла внутри шага: угол по линии 1110-2020 (0) превысил 180 (цикл АР 1) при t=1,5"
            ' 2. "Угол по линии 121-333 (0) превысил 180 (цикл АР 1) при t=1.2"
            If (InStr(1, logLine, "угол по линии", vbTextCompare) > 0 Or _
                InStr(1, logLine, "Угол по линии", vbTextCompare) > 0) And _
               InStr(1, logLine, "превысил", vbTextCompare) > 0 And _
               InStr(1, logLine, "цикл АР", vbTextCompare) > 0 Then
                
                foundTotal = foundTotal + 1
                
                ' Записываем основные данные
                ws.Cells(rowNum, 1).Value = foundTotal
                ws.Cells(rowNum, 2).Value = "Текущий расчет"
                ws.Cells(rowNum, 3).Value = logLine
                
                ' Парсим данные из строки
                
                ' Извлекаем линию и параллельность (формат XXXX-YYYY (N))
                Set regexLine = CreateObject("VBScript.RegExp")
                regexLine.Pattern = "линии\s+(\d+-\d+)\s*\((\d+)\)"
                regexLine.IgnoreCase = True
                If regexLine.Test(logLine) Then
                    Set matchLine = regexLine.Execute(logLine)
                    ws.Cells(rowNum, 4).Value = matchLine(0).SubMatches(0)  ' Линия
                    ws.Cells(rowNum, 5).Value = CInt(matchLine(0).SubMatches(1))  ' Параллельность
                End If
                
                ' Извлекаем угол после параллельности и перед "превысил"
                ' Может быть в формате: "(N) превысил" где N - это порог, но нам нужен угол ДО превысил
                ' На самом деле в примере угол не указан явно, только порог
                ' Попробуем найти число перед "превысил" в контексте
                
                ' Извлекаем порог (число после "превысил")
                Set regexThreshold = CreateObject("VBScript.RegExp")
                regexThreshold.Pattern = "превысил\s+(\d+)"
                regexThreshold.IgnoreCase = True
                If regexThreshold.Test(logLine) Then
                    Set matchThreshold = regexThreshold.Execute(logLine)
                    ws.Cells(rowNum, 7).Value = CDbl(matchThreshold(0).SubMatches(0))
                End If
                
                ' Извлекаем цикл АР
                Set regexCycle = CreateObject("VBScript.RegExp")
                regexCycle.Pattern = "цикл АР\s+(\d+)"
                regexCycle.IgnoreCase = True
                If regexCycle.Test(logLine) Then
                    Set matchCycle = regexCycle.Execute(logLine)
                    ws.Cells(rowNum, 8).Value = CInt(matchCycle(0).SubMatches(0))
                End If
                
                ' Извлекаем время (t=X,X или t=X.X)
                Set regexTime = CreateObject("VBScript.RegExp")
                regexTime.Pattern = "при\s+t\s*=\s*([0-9]+[,.]?[0-9]*)"
                regexTime.IgnoreCase = True
                If regexTime.Test(logLine) Then
                    Set matchTime = regexTime.Execute(logLine)
                    timeStr = matchTime(0).SubMatches(0)
                    timeStr = Replace(timeStr, ",", ".")
                    ws.Cells(rowNum, 9).Value = CDbl(timeStr)
                End If
                
                rowNum = rowNum + 1
            End If
        Next
        
        ' Форматирование
        ws.Columns.AutoFit
        
        ' Итоговое сообщение
        If foundTotal > 0 Then
            MsgBox "Найдено записей о блокировке АР: " & foundTotal, vbInformation, "Анализ завершен"
        Else
            MsgBox "Записи о блокировке фиксации АР не найдены", vbInformation, "Анализ завершен"
        End If
    Else
        MsgBox "Ошибка расчета FWDynamic (код: " & nRes & ")", vbExclamation, "Ошибка"
    End If
Else
    MsgBox "FWDynamic недоступен", vbCritical, "Ошибка"
End If

' Очистка
xl.DisplayAlerts = True
Set ws = Nothing
Set wb = Nothing
Set xl = Nothing
Set spFWDynamic = Nothing


' ============================================================
' ВЕРСИЯ С ОБРАБОТКОЙ МНОЖЕСТВА СЦЕНАРИЕВ
' ============================================================
' Раскомментируйте этот блок, если нужно обработать папку со сценариями

' Пути к сценариям
'ScenarioTemplatePath = "C:\Users\k.marchuk\Desktop\сценарии\1.scn"
'ScenarioFolderPath   = "C:\Users\k.marchuk\Desktop\сценарии"

' Инициализация
'Set fso = CreateObject("Scripting.FileSystemObject")
'Set xl = CreateObject("Excel.Application")
'xl.Visible = True
'xl.DisplayAlerts = False
'Set wb = xl.Workbooks.Add
'Set ws = wb.Worksheets(1)
'ws.Name = "Блокировки АР"

' Заголовки
'ws.Cells(1, 1).Value = "№"
'ws.Cells(1, 2).Value = "Сценарий"
'ws.Cells(1, 3).Value = "Полный текст лога"
'ws.Cells(1, 4).Value = "Линия"
'ws.Cells(1, 5).Value = "Параллельность"
'ws.Cells(1, 6).Value = "Угол"
'ws.Cells(1, 7).Value = "Порог"
'ws.Cells(1, 8).Value = "Цикл АР"
'ws.Cells(1, 9).Value = "Время (t)"
'ws.Range("A1:I1").Font.Bold = True

'rowNum = 2
'foundTotal = 0
'scenarioCount = 0

' Обход файлов сценариев
'If fso.FolderExists(ScenarioFolderPath) Then
'    For Each f In fso.GetFolder(ScenarioFolderPath).Files
'        If LCase(Right(f.Name, 4)) = ".scn" And f.Path <> ScenarioTemplatePath Then
'            On Error Resume Next
'            loadResult = Rastr.Load(1, f.Path, ScenarioTemplatePath)
'            errNum = Err.Number
'            On Error GoTo 0
'            
'            If errNum = 0 And loadResult = 0 Then
'                scenarioCount = scenarioCount + 1
'                Set spFWDynamic = Rastr.FWDynamic
'                
'                If Not spFWDynamic Is Nothing Then
'                    nRes = spFWDynamic.Run()
'                    
'                    If nRes = 0 Then
'                        resultMsg = spFWDynamic.ResultMessage
'                        msgLines = Split(resultMsg, vbCrLf)
'                        If UBound(msgLines) = -1 Then msgLines = Split(resultMsg, vbLf)
'                        
'                        For i = 0 To UBound(msgLines)
'                            logLine = Trim(msgLines(i))
'                            
'                            If (InStr(1, logLine, "угол по линии", vbTextCompare) > 0 Or _
'                                InStr(1, logLine, "Угол по линии", vbTextCompare) > 0) And _
'                               InStr(1, logLine, "превысил", vbTextCompare) > 0 And _
'                               InStr(1, logLine, "цикл АР", vbTextCompare) > 0 Then
'                                
'                                foundTotal = foundTotal + 1
'                                ws.Cells(rowNum, 1).Value = foundTotal
'                                ws.Cells(rowNum, 2).Value = f.Name
'                                ws.Cells(rowNum, 3).Value = logLine
'                                
'                                ' Линия и параллельность
'                                Set regexLine = CreateObject("VBScript.RegExp")
'                                regexLine.Pattern = "линии\s+(\d+-\d+)\s*\((\d+)\)"
'                                regexLine.IgnoreCase = True
'                                If regexLine.Test(logLine) Then
'                                    Set matchLine = regexLine.Execute(logLine)
'                                    ws.Cells(rowNum, 4).Value = matchLine(0).SubMatches(0)
'                                    ws.Cells(rowNum, 5).Value = CInt(matchLine(0).SubMatches(1))
'                                End If
'                                
'                                ' Порог
'                                Set regexThreshold = CreateObject("VBScript.RegExp")
'                                regexThreshold.Pattern = "превысил\s+(\d+)"
'                                regexThreshold.IgnoreCase = True
'                                If regexThreshold.Test(logLine) Then
'                                    ws.Cells(rowNum, 7).Value = CDbl(regexThreshold.Execute(logLine)(0).SubMatches(0))
'                                End If
'                                
'                                ' Цикл АР
'                                Set regexCycle = CreateObject("VBScript.RegExp")
'                                regexCycle.Pattern = "цикл АР\s+(\d+)"
'                                regexCycle.IgnoreCase = True
'                                If regexCycle.Test(logLine) Then
'                                    ws.Cells(rowNum, 8).Value = CInt(regexCycle.Execute(logLine)(0).SubMatches(0))
'                                End If
'                                
'                                ' Время
'                                Set regexTime = CreateObject("VBScript.RegExp")
'                                regexTime.Pattern = "при\s+t\s*=\s*([0-9]+[,.]?[0-9]*)"
'                                regexTime.IgnoreCase = True
'                                If regexTime.Test(logLine) Then
'                                    timeStr = regexTime.Execute(logLine)(0).SubMatches(0)
'                                    ws.Cells(rowNum, 9).Value = CDbl(Replace(timeStr, ",", "."))
'                                End If
'                                
'                                rowNum = rowNum + 1
'                            End If
'                        Next
'                    End If
'                End If
'            End If
'        End If
'    Next
'    
'    ws.Columns.AutoFit
'    MsgBox "Обработано сценариев: " & scenarioCount & vbCrLf & _
'           "Найдено записей о блокировке АР: " & foundTotal, vbInformation, "Анализ завершен"
'    
'    xl.DisplayAlerts = True
'    Set ws = Nothing
'    Set wb = Nothing
'    Set xl = Nothing
'    Set fso = Nothing
'End If
