' ============================================================
' СПОСОБ 2: Чтение таблицы Protocol после расчёта
' ============================================================
' Этот способ читает таблицу Protocol после выполнения расчёта
' и сохраняет все сообщения в файл
' ============================================================

Sub Main_Sposob2()
    Dim logFilePath As String
    Dim logFileNum As Integer
    
    logFilePath = "D:\PycharmProjects\script_rustab\logs\rastr_log_sposob2.txt"
    logFileNum = FreeFile
    
    ' Открываем файл для записи
    Open logFilePath For Output As #logFileNum
    Print #logFileNum, "=== ЛОГ RASTRWIN (Таблица Protocol) ==="
    Print #logFileNum, "Начало: " & Now()
    Print #logFileNum, String(50, "=")
    
    ' ========================================
    ' ЗДЕСЬ ВАШ КОД РАСЧЁТА
    ' ========================================
    
    ' Пример:
    ' Rastr.Load 1, "путь_к_сценарию.scn", "шаблон.scn"
    Set spFWDynamic = Rastr.FWDynamic
    ' result = spFWDynamic.Run()
    
    ' ========================================
    ' КОНЕЦ ВАШЕГО КОДА РАСЧЁТА
    ' ========================================
    
    ' Чтение таблицы Protocol
    On Error Resume Next
    Set tblProt = Rastr.Tables("Protocol")
    errNum = Err.Number
    On Error GoTo 0
    
    If errNum = 0 And Not tblProt Is Nothing Then
        Print #logFileNum, ""
        Print #logFileNum, "--- Содержимое таблицы Protocol ---"
        Print #logFileNum, "Количество записей: " & tblProt.Size
        Print #logFileNum, ""
        
        ' Получаем колонки
        On Error Resume Next
        Set colMessage = tblProt.Cols("Message")
        Set colLevel = tblProt.Cols("Level")
        Set colTime = tblProt.Cols("Time")
        Set colStage = tblProt.Cols("StageId")
        On Error GoTo 0
        
        For i = 0 To tblProt.Size - 1
            Dim logLine As String
            Dim levelStr As String
            Dim timeVal As String
            Dim msgVal As String
            Dim stageVal As String
            
            ' Читаем значения с проверкой на Nothing
            On Error Resume Next
            
            If Not colLevel Is Nothing Then
                Select Case colLevel.Z(i)
                    Case 0: levelStr = "INFO"
                    Case 1: levelStr = "WARNING"
                    Case 2: levelStr = "ERROR"
                    Case Else: levelStr = "LVL" & colLevel.Z(i)
                End Select
            Else
                levelStr = "???"
            End If
            
            If Not colTime Is Nothing Then
                timeVal = Format(colTime.Z(i), "0.000")
            Else
                timeVal = "---"
            End If
            
            If Not colMessage Is Nothing Then
                msgVal = colMessage.ZS(i)
            Else
                msgVal = "(нет сообщения)"
            End If
            
            If Not colStage Is Nothing Then
                stageVal = "Stage:" & colStage.Z(i)
            Else
                stageVal = ""
            End If
            
            On Error GoTo 0
            
            logLine = "[" & levelStr & "] T=" & timeVal & " " & stageVal & " | " & msgVal
            Print #logFileNum, logLine
        Next
        
        Print #logFileNum, ""
        Print #logFileNum, "--- Конец таблицы Protocol ---"
    Else
        Print #logFileNum, "ВНИМАНИЕ: Таблица Protocol недоступна или пуста"
    End If
    
    Print #logFileNum, String(50, "=")
    Print #logFileNum, "Окончание: " & Now()
    Close #logFileNum
    
    MsgBox "Логи сохранены в: " & logFilePath
End Sub

' ============================================================
' Функция для чтения Protocol и возврата массива сообщений
' ============================================================
Function GetProtocolMessages() As String()
    Dim messages() As String
    Dim msgCount As Integer
    
    On Error Resume Next
    Set tblProt = Rastr.Tables("Protocol")
    errNum = Err.Number
    On Error GoTo 0
    
    If errNum = 0 And Not tblProt Is Nothing Then
        msgCount = tblProt.Size
        If msgCount > 0 Then
            ReDim messages(0 To msgCount - 1)
            Set colMessage = tblProt.Cols("Message")
            For i = 0 To msgCount - 1
                messages(i) = colMessage.ZS(i)
            Next
        End If
    End If
    
    GetProtocolMessages = messages
End Function

' ============================================================
' Пример интеграции с Excel
' ============================================================
Sub WriteProtocolToExcel(ws As Object, startRow As Integer, startCol As Integer)
    On Error Resume Next
    Set tblProt = Rastr.Tables("Protocol")
    On Error GoTo 0
    
    If Not tblProt Is Nothing Then
        ws.Cells(startRow, startCol).Value = "=== ПРОТОКОЛ РАСЧЁТА ==="
        ws.Cells(startRow, startCol).Font.Bold = True
        
        Set colMessage = tblProt.Cols("Message")
        Set colLevel = tblProt.Cols("Level")
        
        For i = 0 To tblProt.Size - 1
            Dim levelStr As String
            Select Case colLevel.Z(i)
                Case 0: levelStr = "INFO"
                Case 1: levelStr = "WARNING"
                Case 2: levelStr = "ERROR"
                Case Else: levelStr = "???"
            End Select
            
            ws.Cells(startRow + i + 1, startCol).Value = levelStr
            ws.Cells(startRow + i + 1, startCol + 1).Value = colMessage.ZS(i)
            
            ' Подсветка ошибок красным
            If colLevel.Z(i) = 2 Then
                ws.Cells(startRow + i + 1, startCol).Interior.Color = RGB(255, 200, 200)
                ws.Cells(startRow + i + 1, startCol + 1).Interior.Color = RGB(255, 200, 200)
            End If
        Next
    End If
End Sub
