' --- Сбор логов динамики через события ---

' Инициализация Excel для результатов
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
Set wb = xl.Workbooks.Add
Set ws = wb.Worksheets(1)
ws.Name = "Логи"

' Заголовки
ws.Cells(1, 1).Value = "№"
ws.Cells(1, 2).Value = "Источник"
ws.Cells(1, 3).Value = "Описание"
ws.Range("A1:C1").Font.Bold = True

' Глобальный счетчик строк
Dim g_rowNum
g_rowNum = 2

' Подключаемся к объекту Rastr с событиями
WScript.ConnectObject Rastr, "Rastr_"

' Запускаем расчет динамики
Set spFWDynamic = Rastr.FWDynamic

If Not spFWDynamic Is Nothing Then
    WScript.Echo "Начало расчета..."
    
    nRes = spFWDynamic.Run()
    
    If nRes = 0 Then
        WScript.Echo "Расчет завершен успешно"
        
        ' Форматирование
        ws.Columns.AutoFit
        ws.Columns("C:C").ColumnWidth = 150
        
        totalLines = g_rowNum - 2
        MsgBox "Собрано логов: " & totalLines, vbInformation, "Готово"
    Else
        MsgBox "Ошибка расчета FWDynamic (код: " & nRes & ")", vbExclamation, "Ошибка"
    End If
Else
    MsgBox "FWDynamic недоступен", vbCritical, "Ошибка"
End If

' Обработчик события OnLog
Sub Rastr_OnLog(Code, Level, StageId, TableName, TableIndex, Description, FormName)
    ws.Cells(g_rowNum, 1).Value = g_rowNum - 1
    ws.Cells(g_rowNum, 2).Value = "OnLog"
    ws.Cells(g_rowNum, 3).Value = Description
    g_rowNum = g_rowNum + 1
    
    ' Выводим в консоль для отладки
    WScript.Echo "OnLog: " & Description
End Sub

' Обработчик события prot
Sub Rastr_prot(str)
    ws.Cells(g_rowNum, 1).Value = g_rowNum - 1
    ws.Cells(g_rowNum, 2).Value = "prot"
    ws.Cells(g_rowNum, 3).Value = str
    g_rowNum = g_rowNum + 1
    
    ' Выводим в консоль для отладки
    WScript.Echo "prot: " & str
End Sub
