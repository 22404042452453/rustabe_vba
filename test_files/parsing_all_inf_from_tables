Rastr.FWDynamic.Run()
Set xl = CreateObject("Excel.Application")
xl.Visible = True
Set wb = xl.Workbooks.Add

' Функция проверки исключения
Function IsExcluded(tableName)
    IsExcluded = False
    If LCase(tableName) = "vetvi" Then IsExcluded = True
    If LCase(tableName) = "node" Then IsExcluded = True
End Function

' Создаём сводную таблицу на первом листе
Set ws = wb.Worksheets(1)
ws.Name = "Сводка"
ws.Cells(1, 1).Value = "Таблица"
ws.Cells(1, 2).Value = "Строк"
ws.Cells(1, 3).Value = "Колонок"
ws.Cells(1, 4).Value = "Статус"
ws.Cells(1, 1).Font.Bold = True
ws.Cells(1, 2).Font.Bold = True
ws.Cells(1, 3).Font.Bold = True
ws.Cells(1, 4).Font.Bold = True

row = 2
processedCount = 0
emptyCount = 0
excludedCount = 0

For i = 0 To Rastr.Tables.Count - 1
    On Error Resume Next
    Set t = Rastr.Tables.Item(i)
    
    If Not t Is Nothing Then
        tableName = t.Name
        tableSize = t.Size
        colsCount = t.Cols.Count
        
        ' Заполняем сводку для ВСЕХ таблиц
        ws.Cells(row, 1).Value = tableName
        ws.Cells(row, 2).Value = tableSize
        ws.Cells(row, 3).Value = colsCount
        
        ' Определяем статус
        If IsExcluded(tableName) Then
            ws.Cells(row, 4).Value = "Исключена"
            excludedCount = excludedCount + 1
        ElseIf tableSize = 0 Then
            ws.Cells(row, 4).Value = "Пустая"
            emptyCount = emptyCount + 1
        Else
            ws.Cells(row, 4).Value = "Обработана"
            
            ' Создаём новый лист для таблицы
            Set newWs = wb.Worksheets.Add
            newWs.Name = Left(tableName, 31)
            
            ' Заголовки столбцов
            newWs.Cells(1, 1).Value = "Строка"
            For col = 0 To colsCount - 1
                newWs.Cells(1, col + 2).Value = t.Cols.Item(col).Name
            Next
            newWs.Rows(1).Font.Bold = True
            
            ' Данные таблицы
            For rowIdx = 0 To tableSize - 1
                newWs.Cells(rowIdx + 2, 1).Value = rowIdx
                
                For col = 0 To colsCount - 1
                    Set colObj = t.Cols.Item(col)
                    
                    On Error Resume Next
                    ' Пробуем как строку
                    val = colObj.ZS(rowIdx)
                    If Err.Number <> 0 Then
                        Err.Clear
                        ' Пробуем как число
                        val = colObj.Z(rowIdx)
                    End If
                    
                    If Err.Number = 0 Then
                        newWs.Cells(rowIdx + 2, col + 2).Value = val
                    Else
                        newWs.Cells(rowIdx + 2, col + 2).Value = "[ошибка]"
                    End If
                    On Error GoTo 0
                Next
            Next
            
            ' Автоподбор ширины столбцов
            newWs.Columns.AutoFit
            
            processedCount = processedCount + 1
        End If
        
        row = row + 1
    End If
    
    On Error GoTo 0
Next

' Автоподбор для сводного листа
ws.Columns.AutoFit

MsgBox "Готово!" & vbCrLf & _
       "Всего таблиц: " & Rastr.Tables.Count & vbCrLf & _
       "Обработано: " & processedCount & vbCrLf & _
       "Пустых: " & emptyCount & vbCrLf & _
       "Исключено: " & excludedCount
