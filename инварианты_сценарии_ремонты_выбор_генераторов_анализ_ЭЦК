' --- ДИАГНОСТИЧЕСКАЯ ВЕРСИЯ СКРИПТА ---
' Этот скрипт записывает ВСЕ результаты и ошибки в Excel

ScenarioTemplatePath = "C:\Users\k.marchuk\Desktop\сценарии\1.scn"
ScenarioFolderPath   = "C:\Users\k.marchuk\Desktop\сценарии"

MaxRepair = 4
MaxRepair_count = 1

' --- Rastr таблицы ---
Set spBranch = Rastr.Tables("vetv")
Set spNode   = Rastr.Tables("node")

' --- ДОБАВИТЬ: Глобальная переменная для динамики ---
Dim spFWDynamic

' --- Инициализация Excel ---
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
Set wb = xl.Workbooks.Add
Set wsData = wb.Worksheets(1)
wsData.Name = "Данные"
Set wsResult = wb.Worksheets.Add
wsResult.Name = "Результаты"
Set wsALAR = wb.Worksheets.Add
wsALAR.Name = "Рекомендации АЛАР"
Set wsDiag = wb.Worksheets.Add
wsDiag.Name = "Диагностика"
Set wsLog = wb.Worksheets.Add
wsLog.Name = "Полный лог"

' === ПРИНУДИТЕЛЬНОЕ СОХРАНЕНИЕ ===
Dim excelSavePath
excelSavePath = "C:\Users\k.marchuk\Desktop\Результаты_" & Replace(Replace(Now(), ":", "-"), " ", "_") & ".xlsx"

' Заголовки
wsResult.Cells(1, 1).Value = "Сценарий"
wsResult.Cells(1, 2).Value = "Режим"
wsResult.Cells(1, 3).Value = "Статус УР"
wsResult.Cells(1, 4).Value = "Статус Динамики"
wsResult.Cells(1, 5).Value = "Код ошибки"
wsResult.Cells(1, 6).Value = "Описание"
wsResult.Range("A1:F1").Font.Bold = True

wsDiag.Cells(1, 1).Value = "Этап"
wsDiag.Cells(1, 2).Value = "Сценарий"
wsDiag.Cells(1, 3).Value = "Параметр"
wsDiag.Cells(1, 4).Value = "Значение"
wsDiag.Cells(1, 5).Value = "Статус"
wsDiag.Range("A1:E1").Font.Bold = True

wsLog.Cells(1, 1).Value = "Время"
wsLog.Cells(1, 2).Value = "Сообщение"
wsLog.Range("A1:B1").Font.Bold = True

wsALAR.Cells(1, 1).Value = "Сценарий"
wsALAR.Cells(1, 2).Value = "Ремонт"
wsALAR.Cells(1, 3).Value = "Генератор"
wsALAR.Cells(1, 4).Value = "Устойчивость"
wsALAR.Cells(1, 5).Value = "Элемент с ЭЦК"
wsALAR.Cells(1, 6).Value = "Тип элемента"
wsALAR.Cells(1, 7).Value = "Узлы ЭЦК"
wsALAR.Range("A1:G1").Font.Bold = True

Dim resultRow: resultRow = 2
Dim diagRow: diagRow = 2
Dim logRow: logRow = 2
Dim alarRow: alarRow = 2
Dim TemplateFieldsAdded: TemplateFieldsAdded = 0

' === ФУНКЦИЯ ЛОГИРОВАНИЯ ===
Sub WriteLog(msg)
    On Error Resume Next
    If IsEmpty(msg) Or IsNull(msg) Then msg = "[пустое сообщение]"
    wsLog.Cells(logRow, 1).Value = Now()
    wsLog.Cells(logRow, 2).Value = CStr(msg)
    logRow = logRow + 1
    ' Убираем частое сохранение
    ' wb.Save
    If Err.Number <> 0 Then
        MsgBox "Ошибка логирования: " & Err.Description & vbCrLf & "Сообщение: " & msg
        Err.Clear
    End If
    On Error GoTo 0
End Sub

' === ФУНКЦИЯ СОХРАНЕНИЯ ===
Sub SaveResults()
    On Error Resume Next
    wb.SaveAs excelSavePath
    If Err.Number = 0 Then
        WriteLog "Файл сохранён: " & excelSavePath
    Else
        WriteLog "Ошибка сохранения: " & Err.Description
    End If
    On Error GoTo 0
End Sub

WriteLog "Скрипт запущен"

' --- Подготовка шаблона ---
PrepareTemplate

If TemplateFieldsAdded = 1 Then
    MsgBox "Поля добавлены. Сохраните модель и запустите скрипт повторно для расчётов.", vbInformation, "Подготовка завершена"
    WScript.Quit
End If

' Проверка наличия обязательных колонок
On Error Resume Next
Set spBranchSel = spBranch.Cols("Report")
If Err.Number <> 0 Then
    MsgBox "Ошибка: В таблице ветвей (vetv) не найдена колонка 'Report'." & vbCrLf & _
           "Добавьте колонку 'Report' типа BOOL в шаблон модели и перезапустите скрипт.", vbCritical, "Ошибка настройки модели"
    WScript.Quit
End If
On Error GoTo 0

Sub PrepareTemplate
    TemplateFieldsAdded = 0
    if spBranch.Cols.Find("Repair") < 0 Then
        spBranch.Cols.Add "Repair", PR_BOOL
        spBranch.Cols("Repair").Prop(FL_ZAG) = "Ремонт"
        TemplateFieldsAdded = 1
    End If
    if spBranch.Cols.Find("_SortKey") < 0 Then
        spBranch.Cols.Add "_SortKey", PR_INT
    End if
    if TemplateFieldsAdded = 1 Then MsgBox "Добавлены поля Ремонт. Сохраните модель, если нужно.",1,"Подготовка шаблона"
End Sub

Set spBranchIp  = spBranch.Cols("ip")
Set spBranchIq  = spBranch.Cols("iq")
Set spBranchNm  = spBranch.Cols("name")
Set spBranchSta = spBranch.Cols("sta")
Set spBranchGrp = spBranch.Cols("groupid")
Set spNodeSta   = spNode.Cols("sta")
Set spNodeName  = spNode.Cols("name")

' === УПРОЩЁННАЯ ВЕРСИЯ БЕЗ COMBINATOR ===
' Для диагностики делаем только базовый расчёт

Sub TopologyStore
    On Error Resume Next
    spNode.Cols.Add "staRes",PR_BOOL
    spBranch.Cols.Add "staRes",PR_BOOL
    On Error GoTo 0
    spNode.SetSel ""
    spNode.Cols("staRes").Calc("sta")
    spBranch.SetSel ""
    spBranch.Cols("staRes").Calc("sta")
End Sub

Sub TopologyRestore
    spNode.SetSel ""
    spNodeSta.Calc("staRes")
    spBranch.SetSel ""
    spBranchSta.Calc("staRes")
End Sub

Function SolveUR()
    WriteLog "Запуск расчёта УР..."
    On Error Resume Next
    urCode = Rastr.rgm("p")
    If Err.Number <> 0 Then
        WriteLog "Ошибка вызова rgm: " & Err.Description
        SolveUR = -999
    Else
        WriteLog "Код возврата УР: " & urCode
        SolveUR = urCode
    End If
    On Error GoTo 0
End Function

' === ДЕТАЛЬНАЯ ПРОВЕРКА ДИНАМИКИ ===
Function CheckDynamicsSetup(scenarioName)
    WriteLog "=== Проверка настроек динамики для " & scenarioName & " ==="

    ' 1. Проверка объекта FWDynamic
    On Error Resume Next
    Set spFWDynamic = Rastr.FWDynamic  ' ВАЖНО: сохраняем в глобальную переменную
    If Err.Number <> 0 Or spFWDynamic Is Nothing Then
        wsDiag.Cells(diagRow, 1).Value = "Объект FWDynamic"
        wsDiag.Cells(diagRow, 2).Value = scenarioName
        wsDiag.Cells(diagRow, 3).Value = "Доступность"
        wsDiag.Cells(diagRow, 4).Value = "Недоступен"
        wsDiag.Cells(diagRow, 5).Value = "ОШИБКА: " & Err.Description
        diagRow = diagRow + 1
        WriteLog "FWDynamic недоступен: " & Err.Description
        CheckDynamicsSetup = False
        Exit Function
    End If
    On Error GoTo 0

    wsDiag.Cells(diagRow, 1).Value = "Объект FWDynamic"
    wsDiag.Cells(diagRow, 2).Value = scenarioName
    wsDiag.Cells(diagRow, 3).Value = "Доступность"
    wsDiag.Cells(diagRow, 4).Value = "Доступен"
    wsDiag.Cells(diagRow, 5).Value = "OK"
    diagRow = diagRow + 1
    WriteLog "FWDynamic доступен"

    ' 2. УБРАТЬ ПРОВЕРКУ TimeStep/TimeTotal - они не существуют
    ' Вместо этого проверяем таблицы параметров динамики

    On Error Resume Next
    Set tblDynPar = Rastr.Tables("com_dynamics")
    If Err.Number = 0 And Not tblDynPar Is Nothing Then
        wsDiag.Cells(diagRow, 1).Value = "Таблица"
        wsDiag.Cells(diagRow, 2).Value = scenarioName
        wsDiag.Cells(diagRow, 3).Value = "com_dynamics"
        wsDiag.Cells(diagRow, 4).Value = "Доступна"
        wsDiag.Cells(diagRow, 5).Value = "OK"
        diagRow = diagRow + 1
        WriteLog "Таблица com_dynamics доступна"
    Else
        wsDiag.Cells(diagRow, 1).Value = "Таблица"
        wsDiag.Cells(diagRow, 2).Value = scenarioName
        wsDiag.Cells(diagRow, 3).Value = "com_dynamics"
        wsDiag.Cells(diagRow, 4).Value = "Недоступна"
        wsDiag.Cells(diagRow, 5).Value = "ПРЕДУПРЕЖДЕНИЕ"
        diagRow = diagRow + 1
        WriteLog "Таблица com_dynamics недоступна"
        Err.Clear
    End If
    On Error GoTo 0

    ' 3. Проверка таблицы генераторов
    Set tblGen = Rastr.Tables("Generator")
    genCount = tblGen.Count
    wsDiag.Cells(diagRow, 1).Value = "Данные"
    wsDiag.Cells(diagRow, 2).Value = scenarioName
    wsDiag.Cells(diagRow, 3).Value = "Генераторов"
    wsDiag.Cells(diagRow, 4).Value = genCount
    wsDiag.Cells(diagRow, 5).Value = IIf(genCount > 0, "OK", "ОШИБКА")
    diagRow = diagRow + 1
    WriteLog "Генераторов: " & genCount

    ' 4. Проверка таблицы возмущений
    On Error Resume Next
    Set tblDst = Rastr.Tables("Disturbance")
    If Err.Number = 0 And Not tblDst Is Nothing Then
        dstCount = tblDst.Count
        wsDiag.Cells(diagRow, 1).Value = "Данные"
        wsDiag.Cells(diagRow, 2).Value = scenarioName
        wsDiag.Cells(diagRow, 3).Value = "Возмущений"
        wsDiag.Cells(diagRow, 4).Value = dstCount
        wsDiag.Cells(diagRow, 5).Value = IIf(dstCount > 0, "OK", "ПРЕДУПРЕЖДЕНИЕ")
        diagRow = diagRow + 1
        WriteLog "Возмущений: " & dstCount
    Else
        wsDiag.Cells(diagRow, 1).Value = "Данные"
        wsDiag.Cells(diagRow, 2).Value = scenarioName
        wsDiag.Cells(diagRow, 3).Value = "Возмущений"
        wsDiag.Cells(diagRow, 4).Value = "Таблица недоступна"
        wsDiag.Cells(diagRow, 5).Value = "ПРЕДУПРЕЖДЕНИЕ"
        diagRow = diagRow + 1
        WriteLog "Таблица Disturbance недоступна"
    End If
    On Error GoTo 0

    SaveResults()
    CheckDynamicsSetup = True
End Function

' === ЗАПИСЬ РЕЗУЛЬТАТОВ С ОШИБКАМИ ===
Sub RecordResult(scenarioName, modeName, urStatus, dynStatus, errCode, errDesc)
    wsResult.Cells(resultRow, 1).Value = scenarioName
    wsResult.Cells(resultRow, 2).Value = modeName
    wsResult.Cells(resultRow, 3).Value = urStatus
    wsResult.Cells(resultRow, 4).Value = dynStatus
    wsResult.Cells(resultRow, 5).Value = errCode
    wsResult.Cells(resultRow, 6).Value = errDesc
    
    ' Подсветка ошибок
    If dynStatus <> "OK" Or urStatus <> "OK" Then
        wsResult.Range(wsResult.Cells(resultRow, 1), wsResult.Cells(resultRow, 6)).Interior.ColorIndex = 6
    End If
    
    resultRow = resultRow + 1
    SaveResults()
End Sub

' === ПОПЫТКА ЗАПУСКА ДИНАМИКИ ===
Sub TryRunDynamics(scenarioName, modeName)
    WriteLog "Попытка расчёта: " & scenarioName & " / " & modeName
    
    ' Шаг 1: УР
    urRes = SolveUR()
    If urRes <> 0 Then
        RecordResult scenarioName, modeName, "Ошибка", "-", urRes, "Расчёт УР не сошёлся"
        WriteLog "УР не сошёлся, код: " & urRes
        Exit Sub
    End If
    RecordResult scenarioName, modeName, "OK", "Запуск...", "", ""
    WriteLog "УР сошёлся успешно"

    ' ДОБАВИТЬ: Проверка что spFWDynamic существует
    If spFWDynamic Is Nothing Then
        wsResult.Cells(resultRow - 1, 4).Value = "Ошибка объекта"
        wsResult.Cells(resultRow - 1, 6).Value = "spFWDynamic = Nothing"
        WriteLog "КРИТИЧЕСКАЯ ОШИБКА: spFWDynamic = Nothing"
        SaveResults()
        Exit Sub
    End If

    WriteLog "spFWDynamic проверен, тип: " & TypeName(spFWDynamic)

    ' Шаг 2: Динамика
    On Error Resume Next
    WriteLog "Вызов spFWDynamic.Run()..."
    dynRes = spFWDynamic.Run()
    dynErr = Err.Number
    dynErrDesc = Err.Description
    On Error GoTo 0
    
    If dynErr <> 0 Then
        wsResult.Cells(resultRow - 1, 4).Value = "Ошибка вызова"
        wsResult.Cells(resultRow - 1, 5).Value = dynErr
        wsResult.Cells(resultRow - 1, 6).Value = dynErrDesc
        WriteLog "Ошибка вызова Run(): " & dynErrDesc
        SaveResults()
        Exit Sub
    End If
    
    WriteLog "Run() вернул код: " & dynRes
    
    If dynRes = 0 Then
        WriteLog "Динамика выполнена успешно, извлекаем данные..."
        wsResult.Cells(resultRow - 1, 4).Value = "OK"

        ' ИЗВЛЕЧЕНИЕ РЕЗУЛЬТАТОВ СРАЗУ ПОСЛЕ Run()
        On Error Resume Next
        dataFound = False
        currentCol = 2  ' Начинаем со второй колонки (первая - время)

        ' Заголовки в wsData
        wsData.Cells(1, 1).Value = "Время"

        For Each genIdx In selectedGenIndices
            genName = colName.ZS(genIdx)

            ' Пытаемся взять последний снимок (MaxSnapshotIndex=1005 до 0)
            Dim Plot
            Set Plot = Nothing
            For snapIdx = 1005 To 0 Step -1
                On Error Resume Next
                tmpPlot = Rastr.GetChainedGraphSnapshot("Generator", "Delta", genIdx, snapIdx)
                errNum = Err.Number
                On Error GoTo 0
                If errNum = 0 And IsArray(tmpPlot) Then
                    Plot = tmpPlot
                    Exit For
                End If
            Next

            If IsArray(Plot) Then
                npoints = UBound(Plot, 1) + 1
                If npoints > 0 Then
                    dataFound = True
                    WriteLog "  OK: Получено " & npoints & " точек Delta для " & genName

                    ' Записываем заголовок
                    wsData.Cells(1, currentCol).Value = genName & " Delta"

                    ' Записываем данные
                    For row = 0 To npoints - 1
                        ' Время (если еще не записано)
                        If currentCol = 2 Then
                            wsData.Cells(row + 2, 1).Value = Plot(row, 0)
                        End If
                        ' Значение Delta
                        wsData.Cells(row + 2, currentCol).Value = Plot(row, 1)
                    Next

                    currentCol = currentCol + 1
                End If
            End If

            ' Аналогично для Omega
            Dim PlotOmega
            Set PlotOmega = Nothing
            For snapIdx = 1005 To 0 Step -1
                On Error Resume Next
                tmpPlot = Rastr.GetChainedGraphSnapshot("Generator", "Omega", genIdx, snapIdx)
                errNum = Err.Number
                On Error GoTo 0
                If errNum = 0 And IsArray(tmpPlot) Then
                    PlotOmega = tmpPlot
                    Exit For
                End If
            Next

            If IsArray(PlotOmega) Then
                npoints = UBound(PlotOmega, 1) + 1
                If npoints > 0 Then
                    dataFound = True
                    WriteLog "  OK: Получено " & npoints & " точек Omega для " & genName

                    ' Записываем заголовок
                    wsData.Cells(1, currentCol).Value = genName & " Omega"

                    ' Записываем данные
                    For row = 0 To npoints - 1
                        wsData.Cells(row + 2, currentCol).Value = PlotOmega(row, 1)
                    Next

                    currentCol = currentCol + 1
                End If
            End If
        Next

        If Not dataFound Then
            WriteLog "ПРЕДУПРЕЖДЕНИЕ: Данные графиков не найдены ни для одного генератора"
            wsResult.Cells(resultRow - 1, 6).Value = "Расчёт выполнен успешно (данные графиков отсутствуют)"
        Else
            WriteLog "Данные успешно записаны в Excel (колонок: " & (currentCol - 1) & ")"
            wsResult.Cells(resultRow - 1, 6).Value = "Расчёт выполнен успешно (данные записаны)"
            wsData.Columns.AutoFit
        End If
        On Error GoTo 0
    Else
        wsResult.Cells(resultRow - 1, 4).Value = "Ошибка"
        wsResult.Cells(resultRow - 1, 5).Value = dynRes
        
        ' Расшифровка кодов ошибок
        Select Case dynRes
            Case 1
                errMsg = "Код 1: Данные динамики не инициализированы или отсутствуют параметры"
            Case 2
                errMsg = "Код 2: Ошибка в процессе расчёта"
            Case 3
                errMsg = "Код 3: Нет сходимости"
            Case Else
                errMsg = "Код " & dynRes & ": Неизвестная ошибка"
        End Select
        
        wsResult.Cells(resultRow - 1, 6).Value = errMsg
        WriteLog "Ошибка динамики: " & errMsg
    End If
    
    SaveResults()
End Sub



' === ОСНОВНОЙ КОД ===
Set fso = CreateObject("Scripting.FileSystemObject")

' Проверка шаблона
If Not fso.FileExists(ScenarioTemplatePath) Then
    WriteLog "ОШИБКА: Шаблон не найден: " & ScenarioTemplatePath
    MsgBox "Шаблон не найден: " & ScenarioTemplatePath, vbCritical
    SaveResults()
    WScript.Quit
End If

' Сбор сценариев
Dim scenarioList()
ReDim scenarioList(-1)

If fso.FolderExists(ScenarioFolderPath) Then
    For Each f In fso.GetFolder(ScenarioFolderPath).Files
        If LCase(Right(f.Name, 4)) = ".scn" And f.Path <> ScenarioTemplatePath Then
            ReDim Preserve scenarioList(UBound(scenarioList) + 1)
            scenarioList(UBound(scenarioList)) = f.Path
        End If
    Next
End If

If UBound(scenarioList) < 0 Then
    WriteLog "ОШИБКА: Не найдено сценариев в " & ScenarioFolderPath
    MsgBox "Не найдено сценариев!", vbExclamation
    SaveResults()
    WScript.Quit
End If

WriteLog "Найдено сценариев: " & (UBound(scenarioList) + 1)

' Выбор генераторов
Set tblGen = Rastr.Tables("Generator")
Set colName = tblGen.Cols("Name")

On Error Resume Next
Set colGenSel = tblGen.Cols("sel")
If Err.Number <> 0 Then
    tblGen.Cols.Add "sel", PR_BOOL
    WriteLog "Добавлено поле sel для генераторов"
    MsgBox "Добавлено поле sel. Выберите генераторы и запустите повторно.", vbInformation
    SaveResults()
    WScript.Quit
End If
On Error GoTo 0

Dim selectedGenIndices()
Dim genCount: genCount = 0

tblGen.SetSel("sel")
genIdx = tblGen.FindNextSel(-1)
While genIdx >= 0
    If genCount = 0 Then
        ReDim selectedGenIndices(0)
    Else
        ReDim Preserve selectedGenIndices(UBound(selectedGenIndices) + 1)
    End If
    selectedGenIndices(UBound(selectedGenIndices)) = genIdx
    genCount = genCount + 1
    genIdx = tblGen.FindNextSel(genIdx)
Wend

If genCount = 0 Then
    WriteLog "ОШИБКА: Не выбрано генераторов"
    MsgBox "Не выбрано ни одного генератора!", vbExclamation
    SaveResults()
    WScript.Quit
End If

WriteLog "Выбрано генераторов: " & genCount

' === ЦИКЛ ПО СЦЕНАРИЯМ ===
For iScn = 0 To UBound(scenarioList)
    scnPath = scenarioList(iScn)
    scenarioName = fso.GetFileName(scnPath)
    
    WriteLog "===== Загрузка сценария: " & scenarioName & " ====="
    
    On Error Resume Next
    Rastr.Load 1, scnPath, ScenarioTemplatePath
    If Err.Number <> 0 Then
        WriteLog "Ошибка загрузки: " & Err.Description
        RecordResult scenarioName, "-", "-", "-", Err.Number, "Ошибка загрузки: " & Err.Description
    Else
        WriteLog "Сценарий загружен успешно"
        
        ' Проверка настроек
        If CheckDynamicsSetup(scenarioName) Then
            ' Базовый расчёт
            Call TopologyStore
            TryRunDynamics scenarioName, "Нормальная схема"
            Call TopologyRestore
        End If
    End If
    On Error GoTo 0
Next

WriteLog "===== РАСЧЁТЫ ЗАВЕРШЕНЫ ====="
wsResult.Columns.AutoFit
wsDiag.Columns.AutoFit
wsLog.Columns.AutoFit
SaveResults()

MsgBox "Расчёты завершены!" & vbCrLf & "Результаты сохранены: " & excelSavePath, vbInformation
