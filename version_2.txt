' --- Параметры сценариев ---
' Задайте путь к шаблону и папке с файлами .scn
ScenarioTemplatePath = "C:\Users\k.marchuk\Desktop\сценарии\1.scn"
ScenarioFolderPath   = "C:\Users\k.marchuk\Desktop\сценарии"

' --- Инициализация FileSystemObject ---
Set fso = CreateObject("Scripting.FileSystemObject")

' --- Инициализация Excel ---
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
Set wb = xl.Workbooks.Add
Set wsData = wb.Worksheets(1)
wsData.Name = "Данные"
Set wsResult = wb.Worksheets.Add
wsResult.Name = "Результаты"

' --- Заголовки результирующего листа будут добавляться для каждого сценария блоками ---
Dim resultRow: resultRow = 1
Dim scenarioCount: scenarioCount = 0

' --- Обход файлов сценариев ---
If Not fso.FolderExists(ScenarioFolderPath) Then
    MsgBox "Папка сценариев не найдена: " & ScenarioFolderPath, vbCritical, "Ошибка"
Else
    For Each f In fso.GetFolder(ScenarioFolderPath).Files
    If LCase(Right(f.Name, 4)) = ".scn" And f.Path <> ScenarioTemplatePath Then
        ' Загружаем сценарий
        Rastr.Load 1, f.Path, ScenarioTemplatePath
        Set spFWDynamic = Rastr.FWDynamic
        If spFWDynamic Is Nothing Then
            MsgBox "FWDynamic не доступен для сценария: " & f.Name, vbExclamation, "Пропуск"
        ElseIf spFWDynamic.Run() <> 0 Then
            MsgBox "Ошибка расчета FWDynamic: " & f.Name, vbExclamation, "Пропуск"
        Else
            scenarioCount = scenarioCount + 1

            ' Очищаем лист данных перед новым сценарием
            wsData.Cells.Clear

            ' Строка с названием сценария
            wsResult.Cells(resultRow, 1).Value = "Сценарий: " & f.Name
            wsResult.Cells(resultRow, 1).Font.Bold = True
            resultRow = resultRow + 1

            ' Заголовок блока результатов
            wsResult.Cells(resultRow, 1).Value = "Генератор"
            wsResult.Cells(resultRow, 2).Value = "Max Delta"
            wsResult.Cells(resultRow, 3).Value = "Min Delta"
            wsResult.Cells(resultRow, 4).Value = "Время Max Delta"
            wsResult.Cells(resultRow, 5).Value = "Нарушение устойчивости"
            wsResult.Cells(resultRow, 6).Value = "Время нарушения устойчивости"
            wsResult.Range(wsResult.Cells(resultRow, 1), wsResult.Cells(resultRow, 6)).Font.Bold = True
            resultRow = resultRow + 1

        ' Таблица генераторов
        On Error Resume Next
        Set tbl = Rastr.Tables("Generator")
        errNum = Err.Number
        On Error GoTo 0
        If errNum <> 0 Or tbl Is Nothing Then
            MsgBox "Таблица Generator недоступна в сценарии: " & f.Name, vbExclamation, "Пропуск"
            GoTo NextScenario
        End If

        Set colName = tbl.Cols("Name")
        If colName Is Nothing Then
            MsgBox "Колонка Name отсутствует в Generator: " & f.Name, vbExclamation, "Пропуск"
            GoTo NextScenario
        End If

        Dim dataCol: dataCol = 1 ' колонки на wsData: Delta, Time, Check>180

        For i = 0 To tbl.Size - 1
            genName = colName.ZS(i)

            On Error Resume Next
            Plot = Rastr.GetChainedGraphSnapshot("Generator", "Delta", i, 0)
            errNum = Err.Number
            On Error GoTo 0

            If errNum = 0 And IsArray(Plot) Then
                npoints = UBound(Plot, 1) + 1
                If npoints > 0 Then
                    deltaCol = dataCol
                    timeCol = dataCol + 1
                    checkCol = dataCol + 2

                    wsData.Cells(1, deltaCol).Value = genName & " (Delta)"
                    wsData.Cells(1, timeCol).Value = genName & " (Time)"
                    wsData.Cells(1, checkCol).Value = genName & " (>180)"

                    ' Запись массива в две колонки: Delta, Time
                    wsData.Cells(2, deltaCol).Resize(npoints, 2).Value = Plot
                    ' Вспомогательная колонка: если Delta > 180, то номер строки, иначе большое число
                    wsData.Cells(2, checkCol).Resize(npoints, 1).FormulaR1C1 = "=IF(RC" & deltaCol & ">180,ROW(),999999)"

                    ' Диапазоны
                    deltaStartAddr = wsData.Cells(2, deltaCol).Address(False, False, 1, True)
                    deltaEndAddr = wsData.Cells(npoints + 1, deltaCol).Address(False, False, 1, True)
                    deltaRange = deltaStartAddr & ":" & deltaEndAddr

                    timeStartAddr = wsData.Cells(2, timeCol).Address(False, False, 1, True)
                    timeEndAddr = wsData.Cells(npoints + 1, timeCol).Address(False, False, 1, True)
                    timeRange = timeStartAddr & ":" & timeEndAddr

                    checkStartAddr = wsData.Cells(2, checkCol).Address(False, False, 1, True)
                    checkEndAddr = wsData.Cells(npoints + 1, checkCol).Address(False, False, 1, True)
                    checkRange = checkStartAddr & ":" & checkEndAddr

                    ' Запись формул в результирующий лист
                    wsResult.Cells(resultRow, 1).Value = genName
                    wsResult.Cells(resultRow, 2).Formula = "=MAX(" & deltaRange & ")"
                    wsResult.Cells(resultRow, 3).Formula = "=MIN(" & deltaRange & ")"
                    wsResult.Cells(resultRow, 4).Formula = "=INDEX(" & timeRange & ",MATCH(MAX(" & deltaRange & ")," & deltaRange & ",0))"
                    wsResult.Cells(resultRow, 5).Formula = "=IF(MAX(" & deltaRange & ")>180,""нарушение устойчивости"",""нарушение устойчивости не выявлено"")"
                    wsResult.Cells(resultRow, 6).Formula = "=IF(AND(MAX(" & deltaRange & ")>180,MIN(" & checkRange & ")<999999),INDEX(" & timeRange & ",MATCH(MIN(" & checkRange & ")," & checkRange & ",0)),"""")"

                    resultRow = resultRow + 1
                    dataCol = dataCol + 3
                End If
            End If
        Next

NextScenario:
    End If
    Next
End If

' --- Пересчет формул и форматирование ---
xl.Calculate
wsData.Columns.AutoFit
wsResult.Columns.AutoFit

' Итоговое сообщение
MsgBox "Обработано сценариев: " & scenarioCount, vbInformation, "Готово"

Cleanup:
xl.DisplayAlerts = True
' xl.Quit ' Раскомментируйте, если нужно закрывать Excel автоматически
Set wsData = Nothing
Set wsResult = Nothing
Set wb = Nothing
Set xl = Nothing
Set fso = Nothing


