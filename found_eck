' ВЕРСИЯ С DIJ - анализ критических углов по ветвям
' Используем dij (правильное название)

' Пересчёт режима (устойчивость/расчёт мощности) перед динамикой
Function SolveUR()
    ' 0 — успех; любые другие коды считаем ошибкой
    SolveUR = Rastr.rgm("p") ' или нужный код расчёта УР
End Function

' === ИНИЦИАЛИЗАЦИЯ ===
Set spFWDynamic = Rastr.FWDynamic

' Инициализация Excel
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
xl.ScreenUpdating = False
Set wb = xl.Workbooks.Add
Set wsData = wb.Worksheets(1)
wsData.Name = "Данные"
Set wsResult = wb.Worksheets.Add
wsResult.Name = "Критические углы"

' === ЗАГОЛОВКИ РЕЗУЛЬТИРУЮЩЕГО ЛИСТА ===
wsResult.Cells(1, 1).Value = "Ветвь"
wsResult.Cells(1, 2).Value = "N нач"
wsResult.Cells(1, 3).Value = "N кон"
wsResult.Cells(1, 4).Value = "Max dij"
wsResult.Cells(1, 5).Value = "Время критического dij"
wsResult.Cells(1, 6).Value = "Статус"
wsResult.Range(wsResult.Cells(1, 1), wsResult.Cells(1, 6)).Font.Bold = True

Dim resultRow: resultRow = 2
Dim dataCol: dataCol = 1

' === ПОЛУЧЕНИЕ ТАБЛИЦЫ ВЕТВЕЙ ===
Set tbl = Rastr.Tables("vetv")
Set colName = tbl.Cols("name")
Set colIp = tbl.Cols("ip")    ' Номер узла начала
Set colIq = tbl.Cols("iq")    ' Номер узла конца
Set colSel = tbl.Cols("sel")  ' Выделение ветви

' Проверяем, есть ли выделенные ветви
Dim hasSelected: hasSelected = False
Dim selCount: selCount = 0
For ii = 0 To tbl.Size - 1
    If colSel.Z(ii) <> 0 Then
        hasSelected = True
        selCount = selCount + 1
    End If
Next

If hasSelected Then
    MsgBox "Найдено выделенных ветвей: " & selCount & vbCrLf & _
           "Анализ будет выполнен только для них.", vbInformation, "Режим выделения"
Else
    MsgBox "Выделенных ветвей нет." & vbCrLf & _
           "Анализ будет выполнен для ВСЕХ ветвей.", vbInformation, "Режим: все ветви"
End If

' === 1. ЗАПУСК ДИНАМИКИ ===
urRes = SolveUR()
If urRes <> 0 Then
    wsResult.Cells(resultRow, 1).Value = "ОШИБКА: расчёт УР не выполнен (код " & urRes & ")"
    MsgBox "Ошибка расчёта УР: " & urRes, vbCritical
    WScript.Quit
End If

dynRes = spFWDynamic.Run()
If dynRes <> 0 Then
    wsResult.Cells(resultRow, 1).Value = "ОШИБКА: расчёт динамики не выполнен (код " & dynRes & ")"
    MsgBox "Ошибка расчёта динамики: " & dynRes, vbCritical
    WScript.Quit
End If

' === 2. ВЫГРУЗКА ВСЕХ ДАННЫХ С DIJ ===
' Собираем ТОЛЬКО ветви с критическими углами (>180°)
Dim allBranchData()
Dim criticalCount: criticalCount = 0

Const MaxSnapshotIndex = 1005
Const CriticalAngle = 180  ' Критический угол в градусах
Dim cachedSnapIdx: cachedSnapIdx = -1  ' Кеш найденного индекса снимка
Dim cachedParamName: cachedParamName = ""  ' Кеш названия параметра

Dim processedCount: processedCount = 0

For i = 0 To tbl.Size - 1
    ' Если есть выделенные ветви - работаем только с ними
    If hasSelected And colSel.Z(i) = 0 Then
        ' Пропускаем невыделенные ветви
    Else
    
    processedCount = processedCount + 1
    vetvName = colName.ZS(i)
    nNACH = colIp.Z(i)
    nKON = colIq.Z(i)
    
    ' Получаем снимки dij для ветви
    PlotDij = Empty
    Dim snapIdx, tmpPlot
    
    ' Если уже нашли рабочий индекс - используем его
    If cachedSnapIdx >= 0 Then
        On Error Resume Next
        tmpPlot = Rastr.GetChainedGraphSnapshot("vetv", cachedParamName, i, cachedSnapIdx)
        errNum = Err.Number
        On Error GoTo 0
        If errNum = 0 And IsArray(tmpPlot) Then
            PlotDij = tmpPlot
        End If
    End If
    
    ' Если кеш не помог или его нет - ищем индекс
    If Not IsArray(PlotDij) Then
        For snapIdx = MaxSnapshotIndex To 0 Step -1
            On Error Resume Next
            tmpPlot = Rastr.GetChainedGraphSnapshot("vetv", "dij", i, snapIdx)
            errNum = Err.Number
            On Error GoTo 0
            If errNum = 0 And IsArray(tmpPlot) Then
                PlotDij = tmpPlot
                cachedSnapIdx = snapIdx
                cachedParamName = "dij"
                Exit For
            End If
        Next
    End If
    
    ' Если не получили dij, попробуем альтернативные параметры
    If Not IsArray(PlotDij) Then
        ' Пробуем Delta
        For snapIdx = MaxSnapshotIndex To 0 Step -1
            On Error Resume Next
            tmpPlot = Rastr.GetChainedGraphSnapshot("vetv", "Delta", i, snapIdx)
            errNum = Err.Number
            On Error GoTo 0
        If errNum = 0 And IsArray(tmpPlot) Then
            PlotDij = tmpPlot
            cachedSnapIdx = snapIdx
            cachedParamName = "Delta"
            Exit For
        End If
    Next
    End If
    
    ' Если всё ещё нет данных, попробуем d_angle
    If Not IsArray(PlotDij) Then
        For snapIdx = MaxSnapshotIndex To 0 Step -1
            On Error Resume Next
            tmpPlot = Rastr.GetChainedGraphSnapshot("vetv", "d_angle", i, snapIdx)
            errNum = Err.Number
            On Error GoTo 0
        If errNum = 0 And IsArray(tmpPlot) Then
            PlotDij = tmpPlot
            cachedSnapIdx = snapIdx
            cachedParamName = "d_angle"
            Exit For
        End If
    Next
    End If
    
    ' Проверяем, есть ли критический угол (>180°) в этой ветви
    Dim isCritical: isCritical = False
    Dim maxAbsAngle: maxAbsAngle = 0
    
    If IsArray(PlotDij) Then
        On Error Resume Next
        Dim arrDims, arrUB, arrLB1, arrLB2
        arrDims = 0
        arrUB = UBound(PlotDij, 2)
        If Err.Number = 0 Then arrDims = 2 Else arrDims = 1
        Err.Clear
        On Error GoTo 0
        
        Dim j
        If arrDims = 2 Then
            ' Двумерный массив (строки, столбцы)
            arrLB1 = LBound(PlotDij, 1)
            arrLB2 = LBound(PlotDij, 2)
            For j = arrLB1 To UBound(PlotDij, 1)
                If Abs(PlotDij(j, arrLB2)) > maxAbsAngle Then
                    maxAbsAngle = Abs(PlotDij(j, arrLB2))
                End If
            Next
        Else
            ' Одномерный массив
            arrLB1 = LBound(PlotDij)
            For j = arrLB1 To UBound(PlotDij)
                If Abs(PlotDij(j)) > maxAbsAngle Then
                    maxAbsAngle = Abs(PlotDij(j))
                End If
            Next
        End If
        
        If maxAbsAngle > CriticalAngle Then
            isCritical = True
        End If
    End If
    
    ' Сохраняем ТОЛЬКО критические ветви
    If isCritical Then
        ReDim Preserve allBranchData(criticalCount)
        Set branchData = CreateObject("Scripting.Dictionary")
        branchData.Add "name", vetvName
        branchData.Add "nNACH", nNACH
        branchData.Add "nKON", nKON
        branchData.Add "PlotDij", PlotDij
        branchData.Add "maxAngle", maxAbsAngle
        branchData.Add "arrDims", arrDims
        Set allBranchData(criticalCount) = branchData
        criticalCount = criticalCount + 1
    End If
    
    End If ' Конец проверки sel
Next

' === 3. АНАЛИЗ И ВЫГРУЗКА КРИТИЧЕСКИХ ДАННЫХ ===
' Выгружаем только ветви с критическими углами
If criticalCount = 0 Then
    wsResult.Cells(resultRow, 1).Value = "Критических углов не обнаружено"
    wsResult.Cells(resultRow, 6).Value = "ВСЕ В НОРМЕ"
    xl.ScreenUpdating = True
    MsgBox "Критических углов (>180°) не обнаружено!", vbInformation, "Готово"
    WScript.Quit
End If

For i = 0 To criticalCount - 1
    Set branchData = allBranchData(i)
    vetvName = branchData("name")
    nNACH = branchData("nNACH")
    nKON = branchData("nKON")
    PlotDij = branchData("PlotDij")
    Dim curArrDims: curArrDims = branchData("arrDims")
    
    If IsArray(PlotDij) Then
        If curArrDims = 2 Then
            npoints = UBound(PlotDij, 1) - LBound(PlotDij, 1) + 1
        Else
            npoints = UBound(PlotDij) - LBound(PlotDij) + 1
        End If
        
        If npoints > 0 Then
            dijCol = dataCol
            timeCol = dataCol + 1
            checkCol = dataCol + 2
            
            ' Заголовки на листе данных
            wsData.Cells(1, dijCol).Value = vetvName & " (dij)"
            wsData.Cells(1, timeCol).Value = vetvName & " (Time)"
            wsData.Cells(1, checkCol).Value = vetvName & " (>180)"
            
            ' Запись массива dij (угол, время)
            wsData.Cells(2, dijCol).Resize(npoints, 2).Value = PlotDij
            
            ' Формула проверки критического значения
            wsData.Cells(2, checkCol).Resize(npoints, 1).FormulaR1C1 = "=IF(ABS(RC" & dijCol & ")>180,ROW(),999999)"
            
            ' Диапазоны для формул
            dijStartAddr = wsData.Cells(2, dijCol).Address(False, False, 1, True)
            dijEndAddr = wsData.Cells(npoints + 1, dijCol).Address(False, False, 1, True)
            dijRange = dijStartAddr & ":" & dijEndAddr
            
            timeStartAddr = wsData.Cells(2, timeCol).Address(False, False, 1, True)
            timeEndAddr = wsData.Cells(npoints + 1, timeCol).Address(False, False, 1, True)
            timeRange = timeStartAddr & ":" & timeEndAddr
            
            checkStartAddr = wsData.Cells(2, checkCol).Address(False, False, 1, True)
            checkEndAddr = wsData.Cells(npoints + 1, checkCol).Address(False, False, 1, True)
            checkRange = checkStartAddr & ":" & checkEndAddr
            
            ' === 4. ЗАПИСЬ РЕЗУЛЬТАТОВ ===
            wsResult.Cells(resultRow, 1).Value = vetvName
            wsResult.Cells(resultRow, 2).Value = nNACH         ' N нач
            wsResult.Cells(resultRow, 3).Value = nKON          ' N кон
            wsResult.Cells(resultRow, 4).Formula = "=MAX(ABS(" & dijRange & "))"
            wsResult.Cells(resultRow, 5).Formula = "=IF(AND(MAX(ABS(" & dijRange & "))>180,MIN(" & checkRange & ")<999999),INDEX(" & timeRange & ",MATCH(MIN(" & checkRange & ")," & checkRange & ",0)),"""")"
            wsResult.Cells(resultRow, 6).Formula = "=IF(MAX(ABS(" & dijRange & "))>180,""КРИТИЧЕСКИЙ dij (ЭЦК)"",""Норма"")"
            
            resultRow = resultRow + 1
            dataCol = dataCol + 3
        End If
    Else
        ' Если не удалось получить данные для ветви
        wsResult.Cells(resultRow, 1).Value = vetvName
        wsResult.Cells(resultRow, 2).Value = nNACH
        wsResult.Cells(resultRow, 3).Value = nKON
        wsResult.Cells(resultRow, 4).Value = "Нет данных"
        wsResult.Cells(resultRow, 5).Value = ""
        wsResult.Cells(resultRow, 6).Value = "ОШИБКА: нет данных динамики"
        resultRow = resultRow + 1
    End If
Next

' === ФИНАЛИЗАЦИЯ ===
' Пересчет и фиксация результатов
xl.Calculate
wsResult.Range(wsResult.Cells(2, 1), wsResult.Cells(resultRow - 1, 6)).Value = _
    wsResult.Range(wsResult.Cells(2, 1), wsResult.Cells(resultRow - 1, 6)).Value

' Форматирование
wsData.Columns.AutoFit
wsResult.Columns.AutoFit

' Подсветка критических углов
For r = 2 To resultRow - 1
    If wsResult.Cells(r, 6).Value = "КРИТИЧЕСКИЙ dij (ЭЦК)" Then
        wsResult.Range(wsResult.Cells(r, 1), wsResult.Cells(r, 6)).Interior.Color = RGB(255, 200, 200)
        wsResult.Cells(r, 6).Font.Bold = True
    End If
Next

Dim modeText
If hasSelected Then modeText = " (выделенные)" Else modeText = " (все)"

xl.ScreenUpdating = True
MsgBox "Анализ завершен!" & vbCrLf & _
       "Всего ветвей в модели: " & tbl.Size & vbCrLf & _
       "Обработано: " & processedCount & modeText & vbCrLf & _
       "Критических (>180°): " & criticalCount, vbInformation, "Готово"

On Error Resume Next
xl.DisplayAlerts = True
On Error GoTo 0
