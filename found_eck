' Настройка снимков перед расчетом
Set spFWDynamic = Rastr.FWDynamic

' ВАЖНО: Настраиваем сохранение снимков для ветвей
Set MacroControl = spFWDynamic.MacroControl

' Добавляем параметры для сохранения в снимки
MacroControl.AddParameter "vetv", "d_ip"
MacroControl.AddParameter "vetv", "d_iq"

' ИЛИ можно добавить все параметры ветвей:
' MacroControl.AddTable "vetv"

' Запуск динамики
spFWDynamic.Run()

' Инициализация Excel
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
Set wb = xl.Workbooks.Add
Set wsData = wb.Worksheets(1)
wsData.Name = "Данные"
Set wsResult = wb.Worksheets.Add
wsResult.Name = "Критические углы"

' Заголовки результирующего листа
wsResult.Cells(1, 1).Value = "Ветвь"
wsResult.Cells(1, 2).Value = "Max взаимный угол"
wsResult.Cells(1, 3).Value = "Время критического угла"
wsResult.Cells(1, 4).Value = "Статус"
wsResult.Range(wsResult.Cells(1, 1), wsResult.Cells(1, 4)).Font.Bold = True

Dim resultRow: resultRow = 2
Const MaxSnapshotIndex = 500

' Получаем таблицу ветвей
Set tbl = Rastr.Tables("vetv")
Set colName = tbl.Cols("name")

Dim dataCol: dataCol = 1

' Проходим по всем ветвям
For i = 0 To tbl.Size - 1
    vetvName = colName.ZS(i)
    
    ' Получаем снимки d_ip (угол начала)
    Set PlotDip = Nothing
    Dim snapIdx, tmpPlot
    For snapIdx = MaxSnapshotIndex To 0 Step -1
        On Error Resume Next
        tmpPlot = Rastr.GetChainedGraphSnapshot("vetv", "d_ip", i, snapIdx)
        errNum = Err.Number
        On Error GoTo 0
        If errNum = 0 And IsArray(tmpPlot) Then
            PlotDip = tmpPlot
            Exit For
        End If
    Next
    
    ' Получаем снимки d_iq (угол конца)
    Set PlotDiq = Nothing
    For snapIdx = MaxSnapshotIndex To 0 Step -1
        On Error Resume Next
        tmpPlot = Rastr.GetChainedGraphSnapshot("vetv", "d_iq", i, snapIdx)
        errNum = Err.Number
        On Error GoTo 0
        If errNum = 0 And IsArray(tmpPlot) Then
            PlotDiq = tmpPlot
            Exit For
        End If
    Next
    
    ' Если оба массива получены
    If IsArray(PlotDip) And IsArray(PlotDiq) Then
        npoints = UBound(PlotDip, 1) + 1
        
        If npoints > 0 Then
            dipCol = dataCol
            timeCol = dataCol + 1
            diqCol = dataCol + 2
            vzaimCol = dataCol + 3
            checkCol = dataCol + 4
            
            ' Заголовки на листе данных
            wsData.Cells(1, dipCol).Value = vetvName & " (d_ip)"
            wsData.Cells(1, timeCol).Value = vetvName & " (Time)"
            wsData.Cells(1, diqCol).Value = vetvName & " (d_iq)"
            wsData.Cells(1, vzaimCol).Value = vetvName & " (Взаимный)"
            wsData.Cells(1, checkCol).Value = vetvName & " (>180)"
            
            ' Запись массива d_ip (угол, время)
            wsData.Cells(2, dipCol).Resize(npoints, 2).Value = PlotDip
            
            ' Запись массива d_iq (только угол)
            For r = 0 To npoints - 1
                wsData.Cells(r + 2, diqCol).Value = PlotDiq(r, 0)
            Next
            
            ' Формула взаимного угла
            wsData.Cells(2, vzaimCol).Resize(npoints, 1).FormulaR1C1 = "=ABS(RC" & dipCol & "-RC" & diqCol & ")"
            
            ' Вспомогательная колонка: если взаимный угол > 180, то номер строки
            wsData.Cells(2, checkCol).Resize(npoints, 1).FormulaR1C1 = "=IF(RC" & vzaimCol & ">180,ROW(),999999)"
            
            ' Диапазоны
            vzaimStartAddr = wsData.Cells(2, vzaimCol).Address(False, False, 1, True)
            vzaimEndAddr = wsData.Cells(npoints + 1, vzaimCol).Address(False, False, 1, True)
            vzaimRange = vzaimStartAddr & ":" & vzaimEndAddr
            
            timeStartAddr = wsData.Cells(2, timeCol).Address(False, False, 1, True)
            timeEndAddr = wsData.Cells(npoints + 1, timeCol).Address(False, False, 1, True)
            timeRange = timeStartAddr & ":" & timeEndAddr
            
            checkStartAddr = wsData.Cells(2, checkCol).Address(False, False, 1, True)
            checkEndAddr = wsData.Cells(npoints + 1, checkCol).Address(False, False, 1, True)
            checkRange = checkStartAddr & ":" & checkEndAddr
            
            ' Запись формул в результирующий лист
            wsResult.Cells(resultRow, 1).Value = vetvName
            wsResult.Cells(resultRow, 2).Formula = "=MAX(" & vzaimRange & ")"
            wsResult.Cells(resultRow, 3).Formula = "=IF(AND(MAX(" & vzaimRange & ")>180,MIN(" & checkRange & ")<999999),INDEX(" & timeRange & ",MATCH(MIN(" & checkRange & ")," & checkRange & ",0)),"""")"
            wsResult.Cells(resultRow, 4).Formula = "=IF(MAX(" & vzaimRange & ")>180,""КРИТИЧЕСКИЙ УГОЛ (ЭЦК)"",""Норма"")"
            
            resultRow = resultRow + 1
            dataCol = dataCol + 5
        End If
    End If
Next

' Пересчет и фиксация результатов
xl.Calculate
wsResult.Range(wsResult.Cells(2, 1), wsResult.Cells(resultRow - 1, 4)).Value = _
    wsResult.Range(wsResult.Cells(2, 1), wsResult.Cells(resultRow - 1, 4)).Value

' Форматирование
wsData.Columns.AutoFit
wsResult.Columns.AutoFit

' Подсветка критических углов
For r = 2 To resultRow - 1
    If wsResult.Cells(r, 4).Value = "КРИТИЧЕСКИЙ УГОЛ (ЭЦК)" Then
        wsResult.Range(wsResult.Cells(r, 1), wsResult.Cells(r, 4)).Interior.Color = RGB(255, 200, 200)
        wsResult.Cells(r, 4).Font.Bold = True
    End If
Next

MsgBox "Анализ завершен!", vbInformation, "Готово"
