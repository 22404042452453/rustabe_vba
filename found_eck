' ВЕРСИЯ С DIJ - анализ критических углов по ветвям
' Используем dij (правильное название)

' Пересчёт режима (устойчивость/расчёт мощности) перед динамикой
Function SolveUR()
    ' 0 — успех; любые другие коды считаем ошибкой
    SolveUR = Rastr.rgm("p") ' или нужный код расчёта УР
End Function

' === ИНИЦИАЛИЗАЦИЯ ===
Set spFWDynamic = Rastr.FWDynamic

' Инициализация Excel
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
Set wb = xl.Workbooks.Add
Set wsData = wb.Worksheets(1)
wsData.Name = "Данные"
Set wsResult = wb.Worksheets.Add
wsResult.Name = "Критические углы"

' === ЗАГОЛОВКИ РЕЗУЛЬТИРУЮЩЕГО ЛИСТА ===
wsResult.Cells(1, 1).Value = "Ветвь"
wsResult.Cells(1, 2).Value = "N нач"
wsResult.Cells(1, 3).Value = "N кон"
wsResult.Cells(1, 4).Value = "Max dij"
wsResult.Cells(1, 5).Value = "Время критического dij"
wsResult.Cells(1, 6).Value = "Статус"
wsResult.Range(wsResult.Cells(1, 1), wsResult.Cells(1, 6)).Font.Bold = True

Dim resultRow: resultRow = 2
Dim dataCol: dataCol = 1

' === ПОЛУЧЕНИЕ ТАБЛИЦЫ ВЕТВЕЙ ===
Set tbl = Rastr.Tables("vetv")
Set colName = tbl.Cols("name")
Set colIp = tbl.Cols("ip")    ' Номер узла начала
Set colIq = tbl.Cols("iq")    ' Номер узла конца

' === 1. ЗАПУСК ДИНАМИКИ ===
urRes = SolveUR()
If urRes <> 0 Then
    wsResult.Cells(resultRow, 1).Value = "ОШИБКА: расчёт УР не выполнен (код " & urRes & ")"
    MsgBox "Ошибка расчёта УР: " & urRes, vbCritical
    WScript.Quit
End If

dynRes = spFWDynamic.Run()
If dynRes <> 0 Then
    wsResult.Cells(resultRow, 1).Value = "ОШИБКА: расчёт динамики не выполнен (код " & dynRes & ")"
    MsgBox "Ошибка расчёта динамики: " & dynRes, vbCritical
    WScript.Quit
End If

' === 2. ВЫГРУЗКА ВСЕХ ДАННЫХ С DIJ ===
' Сначала собираем ВСЕ данные из динамики в структурированном виде
Dim allBranchData()
ReDim allBranchData(tbl.Size - 1)

Const MaxSnapshotIndex = 1005

For i = 0 To tbl.Size - 1
    vetvName = colName.ZS(i)
    nNACH = colIp.Z(i)
    nKON = colIq.Z(i)
    
    ' Получаем снимки dij для ветви
    Set PlotDij = Nothing
    Dim snapIdx, tmpPlot
    For snapIdx = MaxSnapshotIndex To 0 Step -1
        On Error Resume Next
        tmpPlot = Rastr.GetChainedGraphSnapshot("vetv", "dij", i, snapIdx)
        errNum = Err.Number
        On Error GoTo 0
        If errNum = 0 And IsArray(tmpPlot) Then
            PlotDij = tmpPlot
            Exit For
        End If
    Next
    
    ' Если не получили dij, попробуем альтернативные параметры
    If Not IsArray(PlotDij) Then
        ' Пробуем Delta
        For snapIdx = MaxSnapshotIndex To 0 Step -1
            On Error Resume Next
            tmpPlot = Rastr.GetChainedGraphSnapshot("vetv", "Delta", i, snapIdx)
            errNum = Err.Number
            On Error GoTo 0
            If errNum = 0 And IsArray(tmpPlot) Then
                PlotDij = tmpPlot
                Exit For
            End If
        Next
    End If
    
    ' Если всё ещё нет данных, попробуем d_angle
    If Not IsArray(PlotDij) Then
        For snapIdx = MaxSnapshotIndex To 0 Step -1
            On Error Resume Next
            tmpPlot = Rastr.GetChainedGraphSnapshot("vetv", "d_angle", i, snapIdx)
            errNum = Err.Number
            On Error GoTo 0
            If errNum = 0 And IsArray(tmpPlot) Then
                PlotDij = tmpPlot
                Exit For
            End If
        Next
    End If
    
    ' Сохраняем данные ветви
    Set branchData = CreateObject("Scripting.Dictionary")
    branchData.Add "name", vetvName
    branchData.Add "nNACH", nNACH
    branchData.Add "nKON", nKON
    branchData.Add "PlotDij", PlotDij
    Set allBranchData(i) = branchData
Next

' === 3. АНАЛИЗ ВЫГРУЖЕННЫХ ДАННЫХ ===
' Теперь анализируем собранные данные
For i = 0 To tbl.Size - 1
    Set branchData = allBranchData(i)
    vetvName = branchData("name")
    nNACH = branchData("nNACH")
    nKON = branchData("nKON")
    Set PlotDij = branchData("PlotDij")
    
    ' Если массив получен
    If IsArray(PlotDij) Then
        npoints = UBound(PlotDij, 1) + 1
        
        If npoints > 0 Then
            dijCol = dataCol
            timeCol = dataCol + 1
            checkCol = dataCol + 2
            
            ' Заголовки на листе данных
            wsData.Cells(1, dijCol).Value = vetvName & " (dij)"
            wsData.Cells(1, timeCol).Value = vetvName & " (Time)"
            wsData.Cells(1, checkCol).Value = vetvName & " (>180)"
            
            ' Запись массива dij (угол, время)
            wsData.Cells(2, dijCol).Resize(npoints, 2).Value = PlotDij
            
            ' Формула проверки критического значения
            wsData.Cells(2, checkCol).Resize(npoints, 1).FormulaR1C1 = "=IF(ABS(RC" & dijCol & ")>180,ROW(),999999)"
            
            ' Диапазоны для формул
            dijStartAddr = wsData.Cells(2, dijCol).Address(False, False, 1, True)
            dijEndAddr = wsData.Cells(npoints + 1, dijCol).Address(False, False, 1, True)
            dijRange = dijStartAddr & ":" & dijEndAddr
            
            timeStartAddr = wsData.Cells(2, timeCol).Address(False, False, 1, True)
            timeEndAddr = wsData.Cells(npoints + 1, timeCol).Address(False, False, 1, True)
            timeRange = timeStartAddr & ":" & timeEndAddr
            
            checkStartAddr = wsData.Cells(2, checkCol).Address(False, False, 1, True)
            checkEndAddr = wsData.Cells(npoints + 1, checkCol).Address(False, False, 1, True)
            checkRange = checkStartAddr & ":" & checkEndAddr
            
            ' === 4. ЗАПИСЬ РЕЗУЛЬТАТОВ ===
            wsResult.Cells(resultRow, 1).Value = vetvName
            wsResult.Cells(resultRow, 2).Value = nNACH         ' N нач
            wsResult.Cells(resultRow, 3).Value = nKON          ' N кон
            wsResult.Cells(resultRow, 4).Formula = "=MAX(ABS(" & dijRange & "))"
            wsResult.Cells(resultRow, 5).Formula = "=IF(AND(MAX(ABS(" & dijRange & "))>180,MIN(" & checkRange & ")<999999),INDEX(" & timeRange & ",MATCH(MIN(" & checkRange & ")," & checkRange & ",0)),"""")"
            wsResult.Cells(resultRow, 6).Formula = "=IF(MAX(ABS(" & dijRange & "))>180,""КРИТИЧЕСКИЙ dij (ЭЦК)"",""Норма"")"
            
            resultRow = resultRow + 1
            dataCol = dataCol + 3
        End If
    Else
        ' Если не удалось получить данные для ветви
        wsResult.Cells(resultRow, 1).Value = vetvName
        wsResult.Cells(resultRow, 2).Value = nNACH
        wsResult.Cells(resultRow, 3).Value = nKON
        wsResult.Cells(resultRow, 4).Value = "Нет данных"
        wsResult.Cells(resultRow, 5).Value = ""
        wsResult.Cells(resultRow, 6).Value = "ОШИБКА: нет данных динамики"
        resultRow = resultRow + 1
    End If
Next

' === ФИНАЛИЗАЦИЯ ===
' Пересчет и фиксация результатов
xl.Calculate
wsResult.Range(wsResult.Cells(2, 1), wsResult.Cells(resultRow - 1, 6)).Value = _
    wsResult.Range(wsResult.Cells(2, 1), wsResult.Cells(resultRow - 1, 6)).Value

' Форматирование
wsData.Columns.AutoFit
wsResult.Columns.AutoFit

' Подсветка критических углов
For r = 2 To resultRow - 1
    If wsResult.Cells(r, 6).Value = "КРИТИЧЕСКИЙ dij (ЭЦК)" Then
        wsResult.Range(wsResult.Cells(r, 1), wsResult.Cells(r, 6)).Interior.Color = RGB(255, 200, 200)
        wsResult.Cells(r, 6).Font.Bold = True
    End If
Next

MsgBox "Анализ завершен! Проанализировано ветвей: " & (resultRow - 2), vbInformation, "Готово"

On Error Resume Next
xl.DisplayAlerts = True
On Error GoTo 0
