' АНАЛИЗ КРИТИЧЕСКИХ УГЛОВ ПО ВЕТВЯМ (dij) - ЧИСТАЯ ВЕРСИЯ

' Пересчёт режима перед динамикой
Function SolveUR()
    SolveUR = Rastr.rgm("p")
End Function

' === ИНИЦИАЛИЗАЦИЯ ===
Set spFWDynamic = Rastr.FWDynamic

' Инициализация Excel
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
xl.ScreenUpdating = False
Set wb = xl.Workbooks.Add
Set wsData = wb.Worksheets(1)
wsData.Name = "Данные"
Set wsResult = wb.Worksheets.Add
wsResult.Name = "Критические углы"

' === ЗАГОЛОВКИ РЕЗУЛЬТИРУЮЩЕГО ЛИСТА ===
wsResult.Cells(1, 1).Value = "Ветвь"
wsResult.Cells(1, 2).Value = "N нач"
wsResult.Cells(1, 3).Value = "N кон"
wsResult.Cells(1, 4).Value = "Max dij"
wsResult.Cells(1, 5).Value = "Время критического dij"
wsResult.Cells(1, 6).Value = "Статус"
wsResult.Range(wsResult.Cells(1, 1), wsResult.Cells(1, 6)).Font.Bold = True

Dim resultRow: resultRow = 2
Dim dataCol: dataCol = 1

' === ПОЛУЧЕНИЕ ТАБЛИЦЫ ВЕТВЕЙ ===
Set tbl = Rastr.Tables("vetv")
Set colName = tbl.Cols("name")
Set colIp = tbl.Cols("ip")
Set colIq = tbl.Cols("iq")
Set colSel = tbl.Cols("sel")

' Проверка выделенных ветвей
Dim hasSelected: hasSelected = False
Dim selCount: selCount = 0
For ii = 0 To tbl.Size - 1
    If colSel.Z(ii) <> 0 Then
        hasSelected = True
        selCount = selCount + 1
    End If
Next

If Not hasSelected Then
    xl.ScreenUpdating = True
    MsgBox "Нет выделенных ветвей! Выделите ветви (sel) для анализа.", vbExclamation, "Нет выделения"
    WScript.Quit
End If

MsgBox "Найдено выделенных ветвей: " & selCount & vbCrLf & _
       "Анализ будет выполнен только для них.", vbInformation, "Режим выделения"

' === ЗАПУСК ДИНАМИКИ ===
urRes = SolveUR()
If urRes <> 0 Then
    wsResult.Cells(resultRow, 1).Value = "ОШИБКА: расчёт УР не выполнен (код " & urRes & ")"
    MsgBox "Ошибка расчёта УР: " & urRes, vbCritical
    WScript.Quit
End If

dynRes = spFWDynamic.Run()
If dynRes <> 0 Then
    wsResult.Cells(resultRow, 1).Value = "ОШИБКА: расчёт динамики не выполнен (код " & dynRes & ")"
    MsgBox "Ошибка расчёта динамики: " & dynRes, vbCritical
    WScript.Quit
End If

' === ВЫГРУЗКА ДАННЫХ ВЫДЕЛЕННЫХ ВЕТВЕЙ ===
Const MaxSnapshotIndex = 1005
Dim cachedSnapIdx: cachedSnapIdx = -1
Dim processedCount: processedCount = 0

For i = 0 To tbl.Size - 1
    If colSel.Z(i) = 0 Then
        ' Пропускаем невыделенные
    Else
    
    Dim vetvName, nNACH, nKON
    vetvName = colName.ZS(i)
    nNACH = colIp.Z(i)
    nKON = colIq.Z(i)
    
    ' Получаем снимки dij для ветви
    Dim PlotDij: PlotDij = Empty
    Dim foundData: foundData = False
    
    ' Используем кеш снимка если найден ранее
    If cachedSnapIdx >= 0 Then
        On Error Resume Next
        PlotDij = Rastr.GetChainedGraphSnapshot("vetv", "dij", i, cachedSnapIdx)
        If Err.Number = 0 And IsArray(PlotDij) Then
            foundData = True
        Else
            cachedSnapIdx = -1
        End If
        Err.Clear
        On Error GoTo 0
    End If
    
    ' Ищем индекс снимка
    If Not foundData Then
        Dim snapIdx
        For snapIdx = MaxSnapshotIndex To 0 Step -1
            On Error Resume Next
            PlotDij = Rastr.GetChainedGraphSnapshot("vetv", "dij", i, snapIdx)
            If Err.Number = 0 And IsArray(PlotDij) Then
                cachedSnapIdx = snapIdx
                foundData = True
                Err.Clear
                Exit For
            End If
            Err.Clear
            On Error GoTo 0
        Next
    End If
    
    ' === ВЫГРУЗКА В EXCEL ===
    If foundData And IsArray(PlotDij) Then
        Dim dijCol, timeCol, checkCol
        dijCol = dataCol
        timeCol = dataCol + 1
        checkCol = dataCol + 2
        
        ' Заголовки
        wsData.Cells(1, dijCol).Value = vetvName & " (dij)"
        wsData.Cells(1, timeCol).Value = vetvName & " (Time)"
        wsData.Cells(1, checkCol).Value = vetvName & " (>180)"
        
        ' Определяем структуру массива
        Dim lb1, ub1, lb2, ub2, is2D
        Dim npoints: npoints = 0
        Dim rowIdx: rowIdx = 2
        
        On Error Resume Next
        lb1 = LBound(PlotDij, 1)
        ub1 = UBound(PlotDij, 1)
        lb2 = LBound(PlotDij, 2)
        ub2 = UBound(PlotDij, 2)
        is2D = (Err.Number = 0)
        Err.Clear
        On Error GoTo 0
        
        ' Если не удалось получить bounds для 1D массива, попробуем ещё раз
        If Not is2D Then
            On Error Resume Next
            lb1 = LBound(PlotDij)
            ub1 = UBound(PlotDij)
            Err.Clear
            On Error GoTo 0
        End If
        
        ' Обработка массива
        If is2D Then
            ' Двумерный массив
            Dim dim1Size, dim2Size
            dim1Size = ub1 - lb1 + 1
            dim2Size = ub2 - lb2 + 1
            
            If dim2Size = 2 Then
                ' Массив (n, 2): каждая строка = [угол, время]
                Dim m
                For m = lb1 To ub1
                    On Error Resume Next
                    wsData.Cells(rowIdx, dijCol).Value = PlotDij(m, lb2)
                    wsData.Cells(rowIdx, timeCol).Value = PlotDij(m, lb2 + 1)
                    If Err.Number = 0 Then rowIdx = rowIdx + 1
                    Err.Clear
                    On Error GoTo 0
                Next
                npoints = rowIdx - 2
            ElseIf dim1Size = 2 Then
                ' Массив (2, n): транспонированный
                Dim n
                For n = lb2 To ub2
                    On Error Resume Next
                    wsData.Cells(rowIdx, dijCol).Value = PlotDij(lb1, n)
                    wsData.Cells(rowIdx, timeCol).Value = PlotDij(lb1 + 1, n)
                    If Err.Number = 0 Then rowIdx = rowIdx + 1
                    Err.Clear
                    On Error GoTo 0
                Next
                npoints = rowIdx - 2
            Else
                ' Другой 2D формат - пробуем первую строку как данные
                Dim k
                For k = lb2 To ub2
                    On Error Resume Next
                    wsData.Cells(rowIdx, dijCol).Value = PlotDij(lb1, k)
                    If Err.Number = 0 Then rowIdx = rowIdx + 1
                    Err.Clear
                    On Error GoTo 0
                Next
                npoints = rowIdx - 2
            End If
        Else
            ' Одномерный массив
            Dim arrSize: arrSize = ub1 - lb1 + 1
            If arrSize > 0 Then
                If arrSize Mod 2 = 0 Then
                    ' Чередующиеся значения [dij1, time1, dij2, time2, ...]
                    Dim p
                    For p = lb1 To ub1 Step 2
                        On Error Resume Next
                        wsData.Cells(rowIdx, dijCol).Value = PlotDij(p)
                        If p + 1 <= ub1 Then
                            wsData.Cells(rowIdx, timeCol).Value = PlotDij(p + 1)
                        End If
                        If Err.Number = 0 Then rowIdx = rowIdx + 1
                        Err.Clear
                        On Error GoTo 0
                    Next
                    npoints = rowIdx - 2
                Else
                    ' Нечётное количество - только углы
                    Dim q
                    For q = lb1 To ub1
                        On Error Resume Next
                        wsData.Cells(rowIdx, dijCol).Value = PlotDij(q)
                        If Err.Number = 0 Then rowIdx = rowIdx + 1
                        Err.Clear
                        On Error GoTo 0
                    Next
                    npoints = rowIdx - 2
                End If
            End If
        End If
        
        ' Создаём формулы если есть данные
        If npoints > 0 Then
            ' Формула проверки |dij| > 180
            wsData.Cells(2, checkCol).Resize(npoints, 1).FormulaR1C1 = _
                "=IF(ABS(RC" & dijCol & ")>180,ROW(),999999)"
            
            ' Диапазоны для результатов
            Dim dijRange, timeRange, checkRange
            dijRange = wsData.Cells(2, dijCol).Address(False, False, 1, True) & ":" & _
                       wsData.Cells(npoints + 1, dijCol).Address(False, False, 1, True)
            timeRange = wsData.Cells(2, timeCol).Address(False, False, 1, True) & ":" & _
                        wsData.Cells(npoints + 1, timeCol).Address(False, False, 1, True)
            checkRange = wsData.Cells(2, checkCol).Address(False, False, 1, True) & ":" & _
                         wsData.Cells(npoints + 1, checkCol).Address(False, False, 1, True)
            
            ' Запись в результаты
            wsResult.Cells(resultRow, 1).Value = vetvName
            wsResult.Cells(resultRow, 2).Value = nNACH
            wsResult.Cells(resultRow, 3).Value = nKON
            
            ' MAX(|dij|) = MAX(макс, -мин)
            wsResult.Cells(resultRow, 4).Formula = _
                "=MAX(MAX(" & dijRange & "),-MIN(" & dijRange & "))"
            
            ' Время когда |dij| > 180
            wsResult.Cells(resultRow, 5).Formula = _
                "=IF(AND(MAX(MAX(" & dijRange & "),-MIN(" & dijRange & "))>180,MIN(" & checkRange & ")<999999)," & _
                "INDEX(" & timeRange & ",MATCH(MIN(" & checkRange & ")," & checkRange & ",0)),"""")"
            
            ' Статус
            wsResult.Cells(resultRow, 6).Formula = _
                "=IF(MAX(MAX(" & dijRange & "),-MIN(" & dijRange & "))>180," & _
                """КРИТИЧЕСКИЙ dij (ЭЦК)"",""Норма"")"
            
            resultRow = resultRow + 1
            dataCol = dataCol + 3
            processedCount = processedCount + 1
        Else
            ' Массив пуст
            wsResult.Cells(resultRow, 1).Value = vetvName
            wsResult.Cells(resultRow, 2).Value = nNACH
            wsResult.Cells(resultRow, 3).Value = nKON
            wsResult.Cells(resultRow, 4).Value = "Пустой массив"
            wsResult.Cells(resultRow, 6).Value = "ОШИБКА: нет точек"
            resultRow = resultRow + 1
            processedCount = processedCount + 1
        End If
    Else
        ' Нет данных для ветви
        wsResult.Cells(resultRow, 1).Value = vetvName
        wsResult.Cells(resultRow, 2).Value = nNACH
        wsResult.Cells(resultRow, 3).Value = nKON
        wsResult.Cells(resultRow, 4).Value = "Нет данных"
        wsResult.Cells(resultRow, 6).Value = "ОШИБКА: нет снимка dij"
        resultRow = resultRow + 1
        processedCount = processedCount + 1
    End If
    
    End If ' Конец проверки sel
Next

' === ФИНАЛИЗАЦИЯ ===
xl.Calculate

' Фиксация результатов (конвертация формул в значения)
If resultRow > 2 Then
    wsResult.Range(wsResult.Cells(2, 1), wsResult.Cells(resultRow - 1, 6)).Value = _
        wsResult.Range(wsResult.Cells(2, 1), wsResult.Cells(resultRow - 1, 6)).Value
End If

wsData.Columns.AutoFit
wsResult.Columns.AutoFit

' Подсветка критических углов
For r = 2 To resultRow - 1
    On Error Resume Next
    If wsResult.Cells(r, 6).Value = "КРИТИЧЕСКИЙ dij (ЭЦК)" Then
        wsResult.Range(wsResult.Cells(r, 1), wsResult.Cells(r, 6)).Interior.Color = RGB(255, 200, 200)
        wsResult.Cells(r, 6).Font.Bold = True
    End If
    Err.Clear
    On Error GoTo 0
Next

xl.ScreenUpdating = True
MsgBox "Анализ завершен!" & vbCrLf & _
       "Обработано ветвей: " & processedCount, vbInformation, "Готово"

xl.DisplayAlerts = True
