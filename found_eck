' ВЕРСИЯ С DIJ - анализ критических углов по ветвям
' Используем dij (правильное название)

' Пересчёт режима (устойчивость/расчёт мощности) перед динамикой
Function SolveUR()
    ' 0 — успех; любые другие коды считаем ошибкой
    SolveUR = Rastr.rgm("p") ' или нужный код расчёта УР
End Function

' === ИНИЦИАЛИЗАЦИЯ ===
Set spFWDynamic = Rastr.FWDynamic

' Инициализация Excel
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
xl.ScreenUpdating = False
Set wb = xl.Workbooks.Add
Set wsData = wb.Worksheets(1)
wsData.Name = "Данные"
Set wsResult = wb.Worksheets.Add
wsResult.Name = "Критические углы"

' === ЗАГОЛОВКИ РЕЗУЛЬТИРУЮЩЕГО ЛИСТА ===
wsResult.Cells(1, 1).Value = "Ветвь"
wsResult.Cells(1, 2).Value = "N нач"
wsResult.Cells(1, 3).Value = "N кон"
wsResult.Cells(1, 4).Value = "Max dij"
wsResult.Cells(1, 5).Value = "Время критического dij"
wsResult.Cells(1, 6).Value = "Статус"
wsResult.Range(wsResult.Cells(1, 1), wsResult.Cells(1, 6)).Font.Bold = True

Dim resultRow: resultRow = 2
Dim dataCol: dataCol = 1

' === ПОЛУЧЕНИЕ ТАБЛИЦЫ ВЕТВЕЙ ===
Set tbl = Rastr.Tables("vetv")
Set colName = tbl.Cols("name")
Set colIp = tbl.Cols("ip")    ' Номер узла начала
Set colIq = tbl.Cols("iq")    ' Номер узла конца
Set colSel = tbl.Cols("sel")  ' Выделение ветви

' Проверяем, есть ли выделенные ветви
Dim hasSelected: hasSelected = False
Dim selCount: selCount = 0
For ii = 0 To tbl.Size - 1
    If colSel.Z(ii) <> 0 Then
        hasSelected = True
        selCount = selCount + 1
    End If
Next

If Not hasSelected Then
    xl.ScreenUpdating = True
    MsgBox "Нет выделенных ветвей! Выделите ветви (sel) для анализа.", vbExclamation, "Нет выделения"
    WScript.Quit
End If

MsgBox "Найдено выделенных ветвей: " & selCount & vbCrLf & _
       "Анализ будет выполнен только для них.", vbInformation, "Режим выделения"

' === 1. ЗАПУСК ДИНАМИКИ ===
urRes = SolveUR()
If urRes <> 0 Then
    wsResult.Cells(resultRow, 1).Value = "ОШИБКА: расчёт УР не выполнен (код " & urRes & ")"
    MsgBox "Ошибка расчёта УР: " & urRes, vbCritical
    WScript.Quit
End If

dynRes = spFWDynamic.Run()
If dynRes <> 0 Then
    wsResult.Cells(resultRow, 1).Value = "ОШИБКА: расчёт динамики не выполнен (код " & dynRes & ")"
    MsgBox "Ошибка расчёта динамики: " & dynRes, vbCritical
    WScript.Quit
End If

' === 2. ВЫГРУЗКА ДАННЫХ ВЫДЕЛЕННЫХ ВЕТВЕЙ ===
Const MaxSnapshotIndex = 1005
Dim cachedSnapIdx: cachedSnapIdx = -1
Dim cachedParamName: cachedParamName = ""
Dim processedCount: processedCount = 0

For i = 0 To tbl.Size - 1
    ' Работаем только с выделенными ветвями
    If colSel.Z(i) = 0 Then
        ' Пропускаем невыделенные
    Else
    
    vetvName = colName.ZS(i)
    nNACH = colIp.Z(i)
    nKON = colIq.Z(i)
    
    ' Получаем снимки dij для ветви
    PlotDij = Empty
    Dim snapIdx, tmpPlot
    
    ' Если уже нашли рабочий индекс - используем его
    If cachedSnapIdx >= 0 Then
        On Error Resume Next
        tmpPlot = Rastr.GetChainedGraphSnapshot("vetv", cachedParamName, i, cachedSnapIdx)
        errNum = Err.Number
        On Error GoTo 0
        If errNum = 0 And IsArray(tmpPlot) Then
            PlotDij = tmpPlot
        Else
            ' Кеш не сработал для этой ветви - сбрасываем
            cachedSnapIdx = -1
            cachedParamName = ""
        End If
    End If
    
    ' Если кеш не помог - ищем индекс
    If Not IsArray(PlotDij) Then
        For snapIdx = MaxSnapshotIndex To 0 Step -1
            On Error Resume Next
            tmpPlot = Rastr.GetChainedGraphSnapshot("vetv", "dij", i, snapIdx)
            errNum = Err.Number
            On Error GoTo 0
            If errNum = 0 And IsArray(tmpPlot) Then
                PlotDij = tmpPlot
                cachedSnapIdx = snapIdx
                cachedParamName = "dij"
                Exit For
            End If
        Next
    End If
    
    ' Пробуем Delta
    If Not IsArray(PlotDij) Then
        For snapIdx = MaxSnapshotIndex To 0 Step -1
            On Error Resume Next
            tmpPlot = Rastr.GetChainedGraphSnapshot("vetv", "Delta", i, snapIdx)
            errNum = Err.Number
            On Error GoTo 0
            If errNum = 0 And IsArray(tmpPlot) Then
                PlotDij = tmpPlot
                cachedSnapIdx = snapIdx
                cachedParamName = "Delta"
                Exit For
            End If
        Next
    End If
    
    ' Пробуем d_angle
    If Not IsArray(PlotDij) Then
        For snapIdx = MaxSnapshotIndex To 0 Step -1
            On Error Resume Next
            tmpPlot = Rastr.GetChainedGraphSnapshot("vetv", "d_angle", i, snapIdx)
            errNum = Err.Number
            On Error GoTo 0
            If errNum = 0 And IsArray(tmpPlot) Then
                PlotDij = tmpPlot
                cachedSnapIdx = snapIdx
                cachedParamName = "d_angle"
                Exit For
            End If
        Next
    End If
    
    ' === ВЫГРУЗКА В EXCEL (без ручного обхода массива) ===
    If IsArray(PlotDij) Then
        dijCol = dataCol
        timeCol = dataCol + 1
        checkCol = dataCol + 2
        
        ' Заголовки на листе данных
        wsData.Cells(1, dijCol).Value = vetvName & " (dij)"
        wsData.Cells(1, timeCol).Value = vetvName & " (Time)"
        wsData.Cells(1, checkCol).Value = vetvName & " (>180)"
        
        ' Запись массива dij (угол, время) - 2 колонки
        On Error Resume Next
        wsData.Range(wsData.Cells(2, dijCol), wsData.Cells(10000, timeCol)).Value = PlotDij
        If Err.Number <> 0 Then
            Err.Clear
            ' Если не получилось - пробуем транспонировать
            wsData.Range(wsData.Cells(2, dijCol), wsData.Cells(10000, timeCol)).Value = xl.WorksheetFunction.Transpose(PlotDij)
        End If
        On Error GoTo 0
        
        ' Определяем сколько строк записалось
        npoints = wsData.Cells(wsData.Rows.Count, dijCol).End(-4162).Row - 1  ' -4162 = xlUp
        
        If npoints > 0 Then
            ' Формула проверки критического значения
            wsData.Cells(2, checkCol).Resize(npoints, 1).FormulaR1C1 = "=IF(ABS(RC" & dijCol & ")>180,ROW(),999999)"
            
            ' Диапазоны для формул
            dijRange = wsData.Cells(2, dijCol).Address(False, False, 1, True) & ":" & _
                       wsData.Cells(npoints + 1, dijCol).Address(False, False, 1, True)
            timeRange = wsData.Cells(2, timeCol).Address(False, False, 1, True) & ":" & _
                        wsData.Cells(npoints + 1, timeCol).Address(False, False, 1, True)
            checkRange = wsData.Cells(2, checkCol).Address(False, False, 1, True) & ":" & _
                         wsData.Cells(npoints + 1, checkCol).Address(False, False, 1, True)
            
            ' Запись в лист результатов
            wsResult.Cells(resultRow, 1).Value = vetvName
            wsResult.Cells(resultRow, 2).Value = nNACH
            wsResult.Cells(resultRow, 3).Value = nKON
            ' MAX абсолютного значения = MAX(макс, -мин)
            wsResult.Cells(resultRow, 4).Formula = "=MAX(MAX(" & dijRange & "),-MIN(" & dijRange & "))"
            wsResult.Cells(resultRow, 5).Formula = "=IF(AND(MAX(MAX(" & dijRange & "),-MIN(" & dijRange & "))>180,MIN(" & checkRange & ")<999999),INDEX(" & timeRange & ",MATCH(MIN(" & checkRange & ")," & checkRange & ",0)),"""")"
            wsResult.Cells(resultRow, 6).Formula = "=IF(MAX(MAX(" & dijRange & "),-MIN(" & dijRange & "))>180,""КРИТИЧЕСКИЙ dij (ЭЦК)"",""Норма"")"
            
            resultRow = resultRow + 1
            dataCol = dataCol + 3
            processedCount = processedCount + 1
        End If
    Else
        ' Нет данных для ветви
        wsResult.Cells(resultRow, 1).Value = vetvName
        wsResult.Cells(resultRow, 2).Value = nNACH
        wsResult.Cells(resultRow, 3).Value = nKON
        wsResult.Cells(resultRow, 4).Value = "Нет данных"
        wsResult.Cells(resultRow, 5).Value = ""
        wsResult.Cells(resultRow, 6).Value = "ОШИБКА: нет данных"
        resultRow = resultRow + 1
        processedCount = processedCount + 1
    End If
    
    End If ' Конец проверки sel
Next

' === ФИНАЛИЗАЦИЯ ===
xl.Calculate

' Фиксация результатов (только если есть данные)
If resultRow > 2 Then
    wsResult.Range(wsResult.Cells(2, 1), wsResult.Cells(resultRow - 1, 6)).Value = _
        wsResult.Range(wsResult.Cells(2, 1), wsResult.Cells(resultRow - 1, 6)).Value
End If

wsData.Columns.AutoFit
wsResult.Columns.AutoFit

' Подсветка критических углов
For r = 2 To resultRow - 1
    If wsResult.Cells(r, 6).Value = "КРИТИЧЕСКИЙ dij (ЭЦК)" Then
        wsResult.Range(wsResult.Cells(r, 1), wsResult.Cells(r, 6)).Interior.Color = RGB(255, 200, 200)
        wsResult.Cells(r, 6).Font.Bold = True
    End If
Next

xl.ScreenUpdating = True
MsgBox "Анализ завершен!" & vbCrLf & _
       "Обработано ветвей: " & processedCount, vbInformation, "Готово"

On Error Resume Next
xl.DisplayAlerts = True
On Error GoTo 0
