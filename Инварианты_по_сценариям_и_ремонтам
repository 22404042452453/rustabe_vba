' --- Параметры сценариев и вариантов ---
' Пути к шаблону и папке со сценариями (.scn)
ScenarioTemplatePath = "C:\Users\k.marchuk\Desktop\сценарии\1.scn"
ScenarioFolderPath   = "C:\Users\k.marchuk\Desktop\сценарии"

' Максимальные числа для Repair (как в вариантах)
MaxRepair = 2
MaxRepair_count = 1

' --- Rastr таблицы ---
Set spBranch = Rastr.Tables("vetv")
Set spNode   = Rastr.Tables("node")

' --- Инициализация Excel ---
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
Set wb = xl.Workbooks.Add
Set wsData = wb.Worksheets(1)
wsData.Name = "Данные"
Set wsResult = wb.Worksheets.Add
wsResult.Name = "Результаты"

' Заголовок результирующего блока будет добавляться на лету
Dim resultRow: resultRow = 1
Dim TemplateFieldsAdded: TemplateFieldsAdded = 0

' --- Подготовка шаблона (из файла вариантов) ---
PrepareTemplate

' --- Вспомогательные объекты/колонки ---
Set spBranchIp  = spBranch.Cols("ip")
Set spBranchIq  = spBranch.Cols("iq")
Set spBranchNm  = spBranch.Cols("name")
Set spBranchSta = spBranch.Cols("sta")
Set spBranchGrp = spBranch.Cols("groupid")
Set spBranchSrt = spBranch.Cols("_SortKey")
Set spBranchI   = spBranch.Cols("ie")
Set spBranchIb  = spBranch.Cols("ib")
Set spBranchIl  = spBranch.Cols("zag_it")
Set spBranchIpr = spBranch.Cols("i_dop_r")
Set spBranchSmx = spBranch.Cols("slmax")
Set spBranchSel = spBranch.Cols("Report")
Set spNodeSta   = spNode.Cols("sta")
Set spNodeNy    = spNode.Cols("ny")
Set spNodeName  = spNode.Cols("name")
Set spNodeUhom  = spNode.Cols("uhom")
Set spNodeUmin  = spNode.Cols("umin")
Set spNodeUmax  = spNode.Cols("umax")
Set spNodeV     = spNode.Cols("vras")

' --- Классы и комбинирование (из файла вариантов) ---
Class Combinator
    Dim Counter()
    Dim V()
    Private m
    Private n
    Private Sub Swap(byref V,i1,i2)
        temp  = V(i1)
        V(i1) = V(i2)
        V(i2) = temp
    End Sub
    public function Init(Vsource,Em,En)
        Init = True
        m = Em
        n = En
        Redim V(UBound(Vsource))
        for i = 0 to UBound(Vsource)
            V(i) = Vsource(i)
        next
        if m > n Then MsgBox "M>N !" : Init = False
        If Init Then
            Redim Counter(n-1)
            for i = 0 to Ubound(Counter)
                Counter(i) = i
            next
        End If
    end function
    public function FirstCombination(byref Vout)
        ReDim Vout(m-1)
        for i = 0 to m-1
            Vout(i) = V(Counter(i))
        next
        FirstCombination = not ((m > n) or (m = 0))
    end function
    public function NextCombination(byref Vout)
        if Counter(m-1) < n - 1 Then
            Counter(m-1) = Counter(m-1) + 1
        Else
            for i = m-2 to 0 step -1
                if Counter(i) < n - m + i Then
                    Counter(i) = Counter(i) + 1
                    for j = i + 1 to m - 1
                        Counter(j) = Counter(j-1) + 1
                    next
                End If
            next
        End if
        Redim Vout(m-1)
        for i = 0 to m-1
            Vout(i) = V(Counter(i))
        next
        if Counter(0) = n - m Then
            NextCombination = 0
        Else
            NextCombination = 1
        End If
    end function
End Class

' --- Вспомогательные процедуры из файла вариантов ---
Sub TopologyStore
    On Error Resume Next
    spNode.Cols.Add "staRes",PR_BOOL
    spBranch.Cols.Add "staRes",PR_BOOL
    On Error GoTo 0
    spNode.SetSel ""
    spNode.Cols("staRes").Calc("sta")
    spBranch.SetSel ""
    spBranch.Cols("staRes").Calc("sta")
End Sub

Sub TopologyRestore
    spNode.SetSel ""
    spNodeSta.Calc("staRes")
    spBranch.SetSel ""
    spBranchSta.Calc("staRes")
End Sub

' Пересчёт режима (устойчивость/расчёт мощности) перед динамикой
Function SolveUR()
    ' 0 — успех; любые другие коды считаем ошибкой
    SolveUR = Rastr.rgm("p") ' или нужный код расчёта УР, совпадающий с вариантом
End Function

Sub PrepareTemplate
    TemplateFieldsAdded = 0
    if spBranch.Cols.Find("Repair") < 0 Then
        spBranch.Cols.Add "Repair", PR_BOOL
        spBranch.Cols("Repair").Prop(FL_ZAG) = "Ремонт"
        TemplateFieldsAdded = 1
    End If
    if spBranch.Cols.Find("Report") < 0 Then
        spBranch.Cols.Add "Report", PR_BOOL
        spBranch.Cols("Report").Prop(FL_ZAG) = "Отчет"
        TemplateFieldsAdded = 1
    End If
    if spBranch.Cols.Find("_SortKey") < 0 Then
        spBranch.Cols.Add "_SortKey", PR_INT
    End if
    if TemplateFieldsAdded = 1 Then MsgBox "Добавлены поля Repair/Outage/Report. Сохраните модель, если нужно.",1,"Подготовка шаблона"
End Sub

Function PlaceOffs (byref V, OffCounter)
    OffList = ""
    for offc = 0 to OffCounter-1
        if offc Then OffList = OffList + ","
        spBranchSta.Z(V(offc)) = 1
        GroupId = spBranchGrp.Z(V(offc))
        if GroupId > 0 Then
            spBranch.SetSel "groupid=" & CStr(GroupId)
            spBranchSta.Calc 1
            spBranch.SetSel ""
        End If
        if(OffList <> "") Then OffList = OffList +  "|" 
        OffList = OffList + Cstr(spBranchNm.ZS(V(offc)))
    next
    PlaceOffs = OffList
End function

' --- Подготовка исходных списков ветвей/узлов ---
Call TopologyStore
Dim BranchIndexes(), NodeIndexes(), RepairIndexes()
Dim fso: Set fso = CreateObject("Scripting.FileSystemObject")

Dim RepairComb
Set RepairComb = new Combinator
Dim RepComb()

Sub RefreshRepairIndexes()
    spBranch.SetSel("Repair")
    ReDim RepairIndexes(spBranch.Count)
    cnt = 0
    ndx = spBranch.FindNextSel(-1)
    While ndx >= 0
        RepairIndexes(cnt) = ndx
        cnt = cnt + 1
        ndx = spBranch.FindNextSel(ndx)
    Wend
    If cnt > 0 Then
        ReDim Preserve RepairIndexes(cnt-1)
    Else
        ReDim RepairIndexes(0)
    End If
    totalRepairs = cnt
    ' Автоподстройка границ перебора
    If MaxRepair <= 0 Or MaxRepair > totalRepairs Then MaxRepair = totalRepairs
    If MaxRepair_count < 0 Then MaxRepair_count = 0
    If MaxRepair_count > MaxRepair Then MaxRepair_count = MaxRepair
End Sub

' --- Функция расчёта динамики и записи результатов по генераторам ---
Sub RunDynamicsAndWrite(genSheet, description)
    ' genSheet: лист wsResult, resultRow — глобальный указатель строки
' description: строка описания УР (Repair)
    wsResult.Cells(resultRow, 1).Value = description
    wsResult.Cells(resultRow, 1).Font.Bold = True
    resultRow = resultRow + 1

    ' заголовок блока
    wsResult.Cells(resultRow, 1).Value = "Генератор"
    wsResult.Cells(resultRow, 2).Value = "Max Delta"
    wsResult.Cells(resultRow, 3).Value = "Min Delta"
    wsResult.Cells(resultRow, 4).Value = "Время Max Delta"
    wsResult.Cells(resultRow, 5).Value = "Нарушение устойчивости"
    wsResult.Cells(resultRow, 6).Value = "Время нарушения устойчивости"
    wsResult.Range(wsResult.Cells(resultRow, 1), wsResult.Cells(resultRow, 6)).Font.Bold = True
    resultRow = resultRow + 1

    Dim scenarioBlockStart: scenarioBlockStart = resultRow

    Set tblGen = Rastr.Tables("Generator")
    If tblGen Is Nothing Then Exit Sub
    Set colName = tblGen.Cols("Name")
    If colName Is Nothing Then Exit Sub

    Dim dataCol: dataCol = 1

    For i = 0 To tblGen.Size - 1
        genName = colName.ZS(i)

        ' Пытаемся взять последний снимок (MaxSnapshotIndex=5000 до 0)
        Set Plot = Nothing
        For snapIdx = 5000 To 0 Step -1
            On Error Resume Next
            tmpPlot = Rastr.GetChainedGraphSnapshot("Generator", "Delta", i, snapIdx)
            errNum = Err.Number
            On Error GoTo 0
            If errNum = 0 And IsArray(tmpPlot) Then
                Plot = tmpPlot
                Exit For
            End If
        Next

        If IsArray(Plot) Then
            npoints = UBound(Plot, 1) + 1
            If npoints > 0 Then
                deltaCol = dataCol
                timeCol = dataCol + 1
                checkCol = dataCol + 2

                wsData.Cells(1, deltaCol).Value = genName & " (Delta)"
                wsData.Cells(1, timeCol).Value = genName & " (Time)"
                wsData.Cells(1, checkCol).Value = genName & " (>360)"

                wsData.Cells(2, deltaCol).Resize(npoints, 2).Value = Plot
                wsData.Cells(2, checkCol).Resize(npoints, 1).FormulaR1C1 = "=IF(RC" & deltaCol & ">360,ROW(),999999)"

                deltaStartAddr = wsData.Cells(2, deltaCol).Address(False, False, 1, True)
                deltaEndAddr = wsData.Cells(npoints + 1, deltaCol).Address(False, False, 1, True)
                deltaRange = deltaStartAddr & ":" & deltaEndAddr

                timeStartAddr = wsData.Cells(2, timeCol).Address(False, False, 1, True)
                timeEndAddr = wsData.Cells(npoints + 1, timeCol).Address(False, False, 1, True)
                timeRange = timeStartAddr & ":" & timeEndAddr

                checkStartAddr = wsData.Cells(2, checkCol).Address(False, False, 1, True)
                checkEndAddr = wsData.Cells(npoints + 1, checkCol).Address(False, False, 1, True)
                checkRange = checkStartAddr & ":" & checkEndAddr

                wsResult.Cells(resultRow, 1).Value = genName
                wsResult.Cells(resultRow, 2).Formula = "=MAX(" & deltaRange & ")"
                wsResult.Cells(resultRow, 3).Formula = "=MIN(" & deltaRange & ")"
                wsResult.Cells(resultRow, 4).Formula = "=INDEX(" & timeRange & ",MATCH(MAX(" & deltaRange & ")," & deltaRange & ",0))"
                wsResult.Cells(resultRow, 5).Formula = "=IF(MAX(" & deltaRange & ")>360,""нарушение устойчивости"",""нарушение устойчивости не выявлено"")"
                wsResult.Cells(resultRow, 6).Formula = "=IF(AND(MAX(" & deltaRange & ")>360,MIN(" & checkRange & ")<999999),INDEX(" & timeRange & ",MATCH(MIN(" & checkRange & ")," & checkRange & ",0)),"""")"

                resultRow = resultRow + 1
                dataCol = dataCol + 3
            End If
        End If
    Next

    ' Фиксируем блок
    Dim scenarioBlockEnd: scenarioBlockEnd = resultRow - 1
    If scenarioBlockEnd >= scenarioBlockStart Then
        xl.Calculate
        wsResult.Range(wsResult.Cells(scenarioBlockStart, 1), wsResult.Cells(scenarioBlockEnd, 6)).Value = _
            wsResult.Range(wsResult.Cells(scenarioBlockStart, 1), wsResult.Cells(scenarioBlockEnd, 6)).Value
    End If
End Sub

' Запуск динамики и запись результатов для текущей топологии
Sub RunDynAndWriteSafe(description)
    urRes = SolveUR()
    If urRes <> 0 Then
        wsResult.Cells(resultRow, 1).Value = description & " — ошибка расчёта УР (код " & urRes & ")"
        resultRow = resultRow + 1
        Exit Sub
    End If
    dynRes = spFWDynamic.Run()
    If dynRes = 0 Then
        RunDynamicsAndWrite wsResult, description
    Else
        wsResult.Cells(resultRow, 1).Value = description & " — ошибка расчёта динамики (код " & dynRes & ")"
        resultRow = resultRow + 1
    End If
End Sub

' --- Основной цикл: сценарии -> комбинации Repair -> динамика по генераторам ---
Dim scenarioCount: scenarioCount = 0
Dim scenarioList()
ReDim scenarioList(-1)

Sub CollectScenarioFiles(folderPath)
    For Each f In fso.GetFolder(folderPath).Files
        If LCase(Right(f.Name, 4)) = ".scn" And f.Path <> ScenarioTemplatePath Then
            ReDim Preserve scenarioList(UBound(scenarioList) + 1)
            scenarioList(UBound(scenarioList)) = f.Path
        End If
    Next
    For Each subf In fso.GetFolder(folderPath).SubFolders
        CollectScenarioFiles subf.Path
    Next
End Sub

If fso.FolderExists(ScenarioFolderPath) Then
    CollectScenarioFiles ScenarioFolderPath
End If

If TemplateFieldsAdded = 1 Then
    MsgBox "Поля добавлены. Сохраните модель и запустите скрипт повторно для расчётов.", vbInformation, "Подготовка завершена"
Else
    If Not fso.FolderExists(ScenarioFolderPath) Then
        MsgBox "Папка сценариев не найдена: " & ScenarioFolderPath, vbCritical, "Ошибка"
    Else
        If UBound(scenarioList) < 0 Then
            MsgBox "Не найдено ни одного .scn в папке (учитывая подкаталоги): " & ScenarioFolderPath, vbExclamation, "Нет сценариев"
        Else
            For iScn = 0 To UBound(scenarioList)
                scnPath = scenarioList(iScn)
                Rastr.Load 1, scnPath, ScenarioTemplatePath
                Set spFWDynamic = Rastr.FWDynamic
                If Not spFWDynamic Is Nothing Then
                    ' Зафиксировать исходную топологию сценария и перечень ремонтных ветвей
                    TopologyStore
                    RefreshRepairIndexes
                    scenarioCount = scenarioCount + 1
                    wsData.Cells.Clear

                    ' Заголовок сценария
                    wsResult.Cells(resultRow, 1).Value = "Сценарий: " & scnPath
                    wsResult.Cells(resultRow, 1).Font.Bold = True
                    resultRow = resultRow + 1

                    ' Базовый расчёт: нормальная схема без ремонтов
                    RunDynAndWriteSafe "УР: Нормальная схема"
                    TopologyRestore

                    ' Перебор только Repair (аварийные отключения не используем)
                    totalRepairs = UBound(RepairIndexes) + 1
                    If MaxRepair > totalRepairs Then MaxRepair = totalRepairs
                    ' Перебор от MaxRepair_count до MaxRepair (без обязательного нуля)
                    For RepOff = MaxRepair_count To MaxRepair
                        ' n в комбинаторе — количество элементов (totalRepairs)
                        RepairComb.Init RepairIndexes, RepOff, totalRepairs
                        If RepairComb.FirstCombination(RepComb) Then
                            Do
                                ' Применяем выбранные Repair
                                RepTitle = PlaceOffs(RepComb, RepOff)
                                ' Запускаем расчёт динамики и запись результатов
                                RunDynAndWriteSafe "УР: Ремонт ВЛ - " & RepTitle
                                ' Восстанавливаем топологию после комбинации
                                TopologyRestore

                                hasNext = RepairComb.NextCombination(RepComb)
                                If hasNext = 0 Then
                                    ' Отработать последнюю комбинацию, которую NextCombination уже сформировал
                                    RepTitle = PlaceOffs(RepComb, RepOff)
                                    RunDynAndWriteSafe "УР: Ремонт ВЛ - " & RepTitle
                                    TopologyRestore
                                    Exit Do
                                End If
                            Loop
                        End If
                    Next

                End If
            Next
        End If
    End If
End If

wsResult.Columns.AutoFit

MsgBox "Обработка завершена. Сценариев: " & scenarioCount, vbInformation, "Готово"

On Error Resume Next
xl.DisplayAlerts = True
On Error GoTo 0
