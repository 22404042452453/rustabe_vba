' --- Скрипт для программного создания КЗ в узле ---
' Глобальная переменная - индекс созданного события
Dim g_ScenarioRowIndex: g_ScenarioRowIndex = -1

' --- Функция создания/изменения КЗ в узле ---
Function CreateOrUpdateKZ(nodeNumber, tStart, tDuration)
    On Error Resume Next
    
    Set tblEvents = Rastr.Tables("DFWAutoActionScn")
    
    If tblEvents Is Nothing Then
        MsgBox "Ошибка: Таблица DFWAutoActionScn не найдена!", vbCritical
        CreateOrUpdateKZ = False
        Exit Function
    End If
    
    ' ПРАВИЛЬНЫЕ имена колонок из вашей таблицы
    Set colType = tblEvents.Cols("Type")
    Set colName = tblEvents.Cols("Name")
    Set colTimeStart = tblEvents.Cols("TimeStart")  ' Время начала
    Set colDT = tblEvents.Cols("DT")                ' Длительность
    Set colObjectClass = tblEvents.Cols("ObjectClass")
    Set colObjectKey = tblEvents.Cols("ObjectKey")  ' Ключ объекта (узел)
    
    If colType Is Nothing Or colDT Is Nothing Or colTimeStart Is Nothing Then
        MsgBox "Ошибка: Не найдены необходимые колонки!", vbCritical
        CreateOrUpdateKZ = False
        Exit Function
    End If
    
    ' Если событие уже создано - просто меняем параметры
    If g_ScenarioRowIndex >= 0 And g_ScenarioRowIndex < tblEvents.Size Then
        If colName.ZS(g_ScenarioRowIndex) = "КЗ программное" Then
            colTimeStart.Z(g_ScenarioRowIndex) = tStart
            colDT.Z(g_ScenarioRowIndex) = tDuration
            If Not colObjectKey Is Nothing Then
                colObjectKey.ZS(g_ScenarioRowIndex) = CStr(nodeNumber)
            End If
            CreateOrUpdateKZ = True
            Exit Function
        End If
    End If
    
    ' Ищем существующее событие "КЗ программное"
    For i = 0 To tblEvents.Size - 1
        If colType.ZS(i) = "Объект" And colName.ZS(i) = "КЗ программное" Then
            g_ScenarioRowIndex = i
            colTimeStart.Z(i) = tStart
            colDT.Z(i) = tDuration
            If Not colObjectKey Is Nothing Then
                colObjectKey.ZS(i) = CStr(nodeNumber)
            End If
            CreateOrUpdateKZ = True
            Exit Function
        End If
    Next
    
    ' Создаём новое событие КЗ
    newRow = tblEvents.AddRow()
    g_ScenarioRowIndex = newRow
    
    ' Заполняем параметры
    colType.ZS(newRow) = "Объект"
    colName.ZS(newRow) = "КЗ программное"
    colTimeStart.Z(newRow) = tStart        ' Время начала КЗ (мс)
    colDT.Z(newRow) = tDuration            ' Длительность КЗ (мс)
    
    ' Устанавливаем класс объекта (узел)
    If Not colObjectClass Is Nothing Then
        colObjectClass.ZS(newRow) = "node"  ' или "Node"
    End If
    
    ' Устанавливаем ключ объекта (номер узла)
    If Not colObjectKey Is Nothing Then
        colObjectKey.ZS(newRow) = CStr(nodeNumber)
    End If
    
    CreateOrUpdateKZ = True
    On Error GoTo 0
End Function

' --- Основная логика ---
' Запрашиваем параметры КЗ
nodeInput = InputBox("Введите номер узла КЗ:", "Параметры КЗ", "1")
If Not IsNumeric(nodeInput) Then
    MsgBox "Неверный номер узла."
    WScript.Quit
End If

tStartInput = InputBox("Введите время возникновения КЗ (мс):", "Параметры КЗ", "100")
If Not IsNumeric(tStartInput) Then
    MsgBox "Неверное время возникновения."
    WScript.Quit
End If

tDurationInput = InputBox("Введите длительность КЗ (мс):", "Параметры КЗ", "150")
If Not IsNumeric(tDurationInput) Then
    MsgBox "Неверная длительность КЗ."
    WScript.Quit
End If

' Создаём/обновляем КЗ
nodeNum = CInt(nodeInput)
tStart = CDbl(tStartInput)
tDuration = CDbl(tDurationInput)

If CreateOrUpdateKZ(nodeNum, tStart, tDuration) Then
    MsgBox "КЗ создано/обновлено!" & vbCrLf & _
           "Узел: " & nodeNum & vbCrLf & _
           "Время возникновения: " & tStart & " мс" & vbCrLf & _
           "Длительность: " & tDuration & " мс" & vbCrLf & _
           "Индекс строки: " & g_ScenarioRowIndex, vbInformation
Else
    MsgBox "Ошибка создания КЗ!", vbCritical
End If
