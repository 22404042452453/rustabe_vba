' --- ДИАГНОСТИЧЕСКАЯ ВЕРСИЯ ---
Sub SetShortCircuitClearingTime(tClear)
    Dim foundEvent: foundEvent = False
    Dim errorMsg: errorMsg = ""
    
    On Error Resume Next
    Set tblEvents = Rastr.Tables("DFWAutoActionScn")
    If Err.Number <> 0 Then
        errorMsg = "Ошибка получения таблицы DFWAutoActionScn: " & Err.Description
        MsgBox errorMsg, vbCritical, "Ошибка"
        On Error GoTo 0
        Exit Sub
    End If
    On Error GoTo 0
    
    If tblEvents Is Nothing Then
        MsgBox "Таблица DFWAutoActionScn = Nothing!", vbCritical, "Ошибка"
        Exit Sub
    End If
    
    ' Проверяем размер таблицы
    If tblEvents.Size = 0 Then
        MsgBox "Таблица DFWAutoActionScn пустая!", vbExclamation, "Предупреждение"
        Exit Sub
    End If
    
    ' Получаем колонки
    On Error Resume Next
    Set colType = tblEvents.Cols("Type")
    Set colOtkl = tblEvents.Cols("Откл")
    On Error GoTo 0
    
    If colType Is Nothing Then
        MsgBox "Колонка 'Type' не найдена в таблице DFWAutoActionScn!", vbCritical, "Ошибка"
        ' Выводим список доступных колонок
        Dim colList: colList = ""
        For c = 0 To tblEvents.Cols.Count - 1
            colList = colList & tblEvents.Cols(c).Name & vbCrLf
        Next
        MsgBox "Доступные колонки:" & vbCrLf & colList, vbInformation, "Список колонок"
        Exit Sub
    End If
    
    If colOtkl Is Nothing Then
        MsgBox "Колонка 'Откл' не найдена в таблице DFWAutoActionScn!", vbCritical, "Ошибка"
        Exit Sub
    End If
    
    ' Ищем событие КЗ и выводим информацию
    Dim debugInfo: debugInfo = "Поиск события КЗ в таблице DFWAutoActionScn:" & vbCrLf & vbCrLf
    
    For i = 0 To tblEvents.Size - 1
        Dim typeVal: typeVal = colType.ZS(i)
        debugInfo = debugInfo & "Строка " & i & ": Type = '" & typeVal & "'"
        
        If typeVal = "КЗ" Then
            foundEvent = True
            Dim oldValue: oldValue = colOtkl.Z(i)
            colOtkl.Z(i) = tClear
            Dim newValue: newValue = colOtkl.Z(i)
            
            debugInfo = debugInfo & " ← НАЙДЕНО!" & vbCrLf
            debugInfo = debugInfo & "  Старое значение Откл: " & oldValue & vbCrLf
            debugInfo = debugInfo & "  Новое значение Откл: " & newValue & vbCrLf
            debugInfo = debugInfo & "  Установлено: " & tClear & vbCrLf
            
            ' Проверяем, действительно ли значение изменилось
            If Abs(newValue - tClear) > 0.001 Then
                debugInfo = debugInfo & "  ВНИМАНИЕ: Значение не установилось корректно!" & vbCrLf
            End If
            
            Exit For
        Else
            debugInfo = debugInfo & vbCrLf
        End If
    Next
    
    If Not foundEvent Then
        debugInfo = debugInfo & vbCrLf & "СОБЫТИЕ КЗ НЕ НАЙДЕНО!"
        MsgBox debugInfo, vbExclamation, "Событие не найдено"
    Else
        ' Раскомментируйте для отладки:
        ' MsgBox debugInfo, vbInformation, "Установка времени КЗ"
        
        ' Записываем в лог Excel
        wsLog.Cells(logRow, 1).Value = "DEBUG"
        wsLog.Cells(logRow, 2).Value = "SetTime"
        wsLog.Cells(logRow, 3).Value = tClear
        wsLog.Cells(logRow, 4).Value = "OK"
        logRow = logRow + 1
    End If
End Sub

' --- АЛЬТЕРНАТИВНЫЙ ВАРИАНТ: Поиск по всем возможным вариантам ---
Sub SetShortCircuitClearingTimeRobust(tClear)
    On Error Resume Next
    Set tblEvents = Rastr.Tables("DFWAutoActionScn")
    If tblEvents Is Nothing Then Exit Sub
    
    Set colType = tblEvents.Cols("Type")
    Set colOtkl = tblEvents.Cols("Откл")
    If colType Is Nothing Or colOtkl Is Nothing Then Exit Sub
    
    ' Массив возможных названий типа КЗ
    Dim kzVariants(5)
    kzVariants(0) = "КЗ"
    kzVariants(1) = "кз"
    kzVariants(2) = "Короткое замыкание"
    kzVariants(3) = "Short circuit"
    kzVariants(4) = "SC"
    kzVariants(5) = "КЗ "  ' С пробелом
    
    For i = 0 To tblEvents.Size - 1
        Dim typeVal: typeVal = Trim(colType.ZS(i))
        
        ' Проверяем все варианты
        For v = 0 To UBound(kzVariants)
            If StrComp(typeVal, kzVariants(v), vbTextCompare) = 0 Then
                colOtkl.Z(i) = tClear
                Exit Sub
            End If
        Next
    Next
    On Error GoTo 0
End Sub

' --- ПРОВЕРКА ЕДИНИЦ ИЗМЕРЕНИЯ ---
' Если колонка "Откл" в секундах, а вы подаёте миллисекунды:
Sub SetShortCircuitClearingTimeInSeconds(tClearMs)
    ' Конвертируем мс в секунды
    tClearSec = tClearMs / 1000.0
    
    On Error Resume Next
    Set tblEvents = Rastr.Tables("DFWAutoActionScn")
    If Not tblEvents Is Nothing Then
        Set colType = tblEvents.Cols("Type")
        Set colOtkl = tblEvents.Cols("Откл")
        If Not colType Is Nothing And Not colOtkl Is Nothing Then
            For i = 0 To tblEvents.Size - 1
                If colType.ZS(i) = "КЗ" Then
                    colOtkl.Z(i) = tClearSec  ' ← В СЕКУНДАХ
                    Exit For
                End If
            Next
        End If
    End If
    On Error GoTo 0
End Sub
