' --- Скрипт для программного создания КЗ в узле ---
' Глобальная переменная - индекс созданного события
Dim g_ScenarioRowIndex: g_ScenarioRowIndex = -1

' --- Функция создания/изменения КЗ в узле ---
Function CreateOrUpdateKZ(nodeNumber, tStart, tDuration)
    On Error Resume Next
    
    Set tblEvents = Rastr.Tables("DFWAutoActionScn")
    
    If tblEvents Is Nothing Then
        MsgBox "Ошибка: Таблица DFWAutoActionScn не найдена!", vbCritical
        CreateOrUpdateKZ = False
        Exit Function
    End If
    
    ' Получаем ВСЕ необходимые колонки
    Set colId = tblEvents.Cols("Id")
    Set colParentId = tblEvents.Cols("ParentId")
    Set colType = tblEvents.Cols("Type")
    Set colName = tblEvents.Cols("Name")
    Set colFormula = tblEvents.Cols("Formula")
    Set colObjectClass = tblEvents.Cols("ObjectClass")
    Set colObjectProp = tblEvents.Cols("ObjectProp")
    Set colObjectKey = tblEvents.Cols("ObjectKey")
    Set colOutputMode = tblEvents.Cols("OutputMode")
    Set colRunsCount = tblEvents.Cols("RunsCount")
    Set colTimeStart = tblEvents.Cols("TimeStart")
    Set colDT = tblEvents.Cols("DT")
    Set colTag = tblEvents.Cols("Tag")
    Set colState = tblEvents.Cols("State")
    
    ' Если событие уже создано - просто меняем параметры
    If g_ScenarioRowIndex >= 0 And g_ScenarioRowIndex < tblEvents.Size Then
        If InStr(colName.ZS(g_ScenarioRowIndex), "КЗ программное") > 0 Then
            colTimeStart.Z(g_ScenarioRowIndex) = tStart
            colDT.Z(g_ScenarioRowIndex) = tDuration
            colObjectKey.Z(g_ScenarioRowIndex) = nodeNumber
            CreateOrUpdateKZ = True
            Exit Function
        End If
    End If
    
    ' Ищем существующее событие "КЗ программное"
    For i = 0 To tblEvents.Size - 1
        If InStr(colName.ZS(i), "КЗ программное") > 0 Then
            g_ScenarioRowIndex = i
            colTimeStart.Z(i) = tStart
            colDT.Z(i) = tDuration
            colObjectKey.Z(i) = nodeNumber
            CreateOrUpdateKZ = True
            Exit Function
        End If
    Next
    
    ' Создаём новое событие КЗ (КОПИРУЕМ ФОРМАТ "Шунт Z")
    newRow = tblEvents.AddRow()
    g_ScenarioRowIndex = newRow
    
    ' Получаем максимальный Id для уникальности
    maxId = 0
    For i = 0 To tblEvents.Size - 1
        If i <> newRow Then
            currentId = colId.Z(i)
            If currentId > maxId Then maxId = currentId
        End If
    Next
    
    ' ЗАПОЛНЯЕМ ВСЕ ПОЛЯ ПО ОБРАЗЦУ "Шунт Z"
    colId.Z(newRow) = maxId + 1           ' Уникальный Id
    colParentId.Z(newRow) = 0              ' Нет родителя
    colType.ZS(newRow) = "Объект"          ' Тип события
    colName.ZS(newRow) = "КЗ программное - узел " & nodeNumber  ' Имя
    colFormula.ZS(newRow) = "0,001"        ' Формула (как у Шунт Z)
    colObjectClass.ZS(newRow) = "node"     ' Класс объекта
    colObjectProp.ZS(newRow) = "x"         ' Свойство (x - реактивное сопротивление)
    colObjectKey.Z(newRow) = nodeNumber    ' НОМЕР УЗЛА (число!)
    colOutputMode.Z(newRow) = 1            ' Режим вывода
    colRunsCount.Z(newRow) = 1             ' Количество запусков
    colTimeStart.Z(newRow) = tStart        ' Время начала (мс)
    colDT.Z(newRow) = tDuration            ' Длительность (мс)
    colTag.ZS(newRow) = "TrackID_" & (maxId + 1) & "_M_S"  ' Уникальный тег
    colState.Z(newRow) = 0                 ' Состояние
    
    CreateOrUpdateKZ = True
    On Error GoTo 0
End Function

' --- Основная логика ---
nodeInput = InputBox("Введите номер узла КЗ:", "Параметры КЗ", "1133")
If Not IsNumeric(nodeInput) Then
    MsgBox "Неверный номер узла."
    WScript.Quit
End If

tStartInput = InputBox("Введите время возникновения КЗ (мс):", "Параметры КЗ", "1")
If Not IsNumeric(tStartInput) Then
    MsgBox "Неверное время возникновения."
    WScript.Quit
End If

tDurationInput = InputBox("Введите длительность КЗ (мс):", "Параметры КЗ", "150")
If Not IsNumeric(tDurationInput) Then
    MsgBox "Неверная длительность КЗ."
    WScript.Quit
End If

' Создаём/обновляем КЗ
nodeNum = CInt(nodeInput)
tStart = CDbl(tStartInput)
tDuration = CDbl(tDurationInput)

If CreateOrUpdateKZ(nodeNum, tStart, tDuration) Then
    MsgBox "КЗ создано!" & vbCrLf & vbCrLf & _
           "Узел: " & nodeNum & vbCrLf & _
           "Время возникновения: " & tStart & " мс" & vbCrLf & _
           "Длительность: " & tDuration & " мс" & vbCrLf & vbCrLf & _
           "Индекс строки: " & g_ScenarioRowIndex & vbCrLf & vbCrLf & _
           "ОТКРОЙТЕ редактор сценариев и проверьте!", vbInformation
Else
    MsgBox "Ошибка создания КЗ!", vbCritical
End If
