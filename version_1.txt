' --- Подключение к Excel ---
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
Set wb = xl.Workbooks.Add
Set wsData = wb.Worksheets(1) ' Лист с исходными данными
wsData.Name = "Данные"
Set wsResult = wb.Worksheets.Add ' Лист с результатами
wsResult.Name = "Результаты"

' --- Заголовки результатов ---
wsResult.Cells(1, 1).Value = "Генератор"
wsResult.Cells(1, 2).Value = "Max Delta"
wsResult.Cells(1, 3).Value = "Min Delta"
wsResult.Cells(1, 4).Value = "Время Max Delta"
wsResult.Cells(1, 5).Value = "Нарушение устойчивости"
wsResult.Cells(1, 6).Value = "Время нарушения устойчивости"

' --- Получение таблицы генераторов ---
On Error Resume Next
Set tbl = Rastr.Tables("Generator")
If Err.Number <> 0 Then
    MsgBox "Ошибка: Таблица Generator не найдена!", vbCritical, "Ошибка"
    wb.Close False
    xl.Quit
    Set xl = Nothing
    WScript.Quit
End If
On Error GoTo 0

Set colName = tbl.Cols("Name")
If colName Is Nothing Then
    MsgBox "Ошибка: Колонка Name не найдена в таблице Generator!", vbCritical, "Ошибка"
    wb.Close False
    xl.Quit
    Set xl = Nothing
    WScript.Quit
End If

' --- Счетчик для результатов ---
Dim genCount: genCount = 0
Dim resultRow: resultRow = 2
Dim dataCol: dataCol = 1 ' Отдельный счетчик для колонок данных (начинаем с 1)

' --- Цикл: обработка генераторов и вычисление Max/Min ---
For i = 0 To tbl.Size - 1
    Dim genName: genName = colName.ZS(i)
    
    ' Получение графика (Double) и не используем Set!
    On Error Resume Next
    Dim Plot: Plot = Rastr.GetChainedGraphSnapshot("Generator", "Delta", i, 0)
    Dim errNum: errNum = Err.Number
    On Error GoTo 0
    
    If errNum = 0 And IsArray(Plot) Then
        ' --- Шаг 1: Запись данных в Excel (лист wsData) ---
        Dim npoints: npoints = UBound(Plot, 1) + 1 ' Количество точек
        
        If npoints > 0 Then
            ' --- Заголовки колонок (используем отдельный счетчик dataCol) ---
            ' В массиве Plot: Plot(j, 0) = Delta, Plot(j, 1) = Time
            Dim deltaCol: deltaCol = dataCol ' Колонка для Delta (первая в массиве)
            Dim timeCol: timeCol = dataCol + 1 ' Колонка для Time (вторая в массиве)
            
            wsData.Cells(1, deltaCol).Value = genName & " (Delta)"
            wsData.Cells(1, timeCol).Value = genName & " (Time)"
            
            ' Запись массива данных целиком через Resize (Plot - это массив [npoints x 2])
            ' Plot(j, 0) -> deltaCol, Plot(j, 1) -> timeCol
            wsData.Cells(2, deltaCol).Resize(npoints, 2).Value = Plot
            
            ' --- Шаг 2: Создание вспомогательной колонки для проверки > 180 (работаем с данными из Excel) ---
            Dim checkCol: checkCol = timeCol + 1 ' Вспомогательная колонка для проверки Delta > 180
            wsData.Cells(1, checkCol).Value = genName & " (>180)"
            ' Заполняем вспомогательную колонку формулой проверки (работаем с данными из Excel)
            Dim deltaStartAddr: deltaStartAddr = wsData.Cells(2, deltaCol).Address(False, False, 1, True)
            Dim deltaEndAddr: deltaEndAddr = wsData.Cells(npoints + 1, deltaCol).Address(False, False, 1, True)
            Dim deltaRange: deltaRange = deltaStartAddr & ":" & deltaEndAddr
            Dim checkStartAddr: checkStartAddr = wsData.Cells(2, checkCol).Address(False, False, 1, True)
            Dim checkEndAddr: checkEndAddr = wsData.Cells(npoints + 1, checkCol).Address(False, False, 1, True)
            Dim checkRange: checkRange = checkStartAddr & ":" & checkEndAddr
            ' Заполняем вспомогательную колонку формулой: если Delta > 180, то номер строки, иначе большое число
            ' Используем относительные ссылки для каждой строки (R1C1 формат)
            wsData.Cells(2, checkCol).Resize(npoints, 1).FormulaR1C1 = "=IF(RC" & deltaCol & ">180,ROW(),999999)"
            
            ' --- Шаг 3: Создание формул MAX и MIN в wsResult, ссылающихся на wsData ---
            Dim timeStartAddr: timeStartAddr = wsData.Cells(2, timeCol).Address(False, False, 1, True)
            Dim timeEndAddr: timeEndAddr = wsData.Cells(npoints + 1, timeCol).Address(False, False, 1, True)
            Dim timeRange: timeRange = timeStartAddr & ":" & timeEndAddr
            
            ' Записываем формулы в wsResult
            wsResult.Cells(resultRow, 1).Value = genName
            wsResult.Cells(resultRow, 2).Formula = "=MAX(" & deltaRange & ")"
            wsResult.Cells(resultRow, 3).Formula = "=MIN(" & deltaRange & ")"
            
            ' Время максимальной Delta (используем INDEX+MATCH)
            wsResult.Cells(resultRow, 4).Formula = "=INDEX(" & timeRange & ",MATCH(MAX(" & deltaRange & ")," & deltaRange & ",0))"
            
            ' Нарушение устойчивости (проверяем, есть ли значения > 180)
            wsResult.Cells(resultRow, 5).Formula = "=IF(MAX(" & deltaRange & ")>180,""нарушение устойчивости"",""нарушение устойчивости не выявлено"")"
            
            ' Время нарушения устойчивости (время первого значения > 180)
            ' Используем MIN вспомогательной колонки для нахождения первой строки с > 180
            Dim checkBaseRow: checkBaseRow = wsData.Cells(2, checkCol).Address(False, False, 1, False)
            Dim checkBaseRowAbs: checkBaseRowAbs = wsData.Cells(2, checkCol).Address(False, False, 1, True)
            ' Если MIN < 999999, значит есть нарушение, находим соответствующее время
            wsResult.Cells(resultRow, 6).Formula = "=IF(AND(MAX(" & deltaRange & ")>180,MIN(" & checkRange & ")<999999),INDEX(" & timeRange & ",MIN(" & checkRange & ")-ROW(" & checkBaseRowAbs & ")+1),"""")"
            
            ' Увеличиваем счетчик колонок с учетом вспомогательной колонки
            dataCol = dataCol + 3
            
            resultRow = resultRow + 1
        genCount = genCount + 1
            
            ' Увеличиваем счетчик колонок для следующего генератора (ПОСЛЕ использования deltaCol!)
            dataCol = dataCol + 2
        End If
    End If
Next

' --- Вычисление всех формул один раз после цикла ---
xl.Calculate

' --- Форматирование ---
wsData.Columns.AutoFit
wsResult.Columns.AutoFit

' --- Форматирование заголовков результатов ---
With wsResult.Range("A1:F1")
    .Font.Bold = True
    .Interior.Color = RGB(200, 200, 200)
End With

' --- Итоговое сообщение ---
If genCount > 0 Then
    MsgBox "Обработка завершена!" & vbCrLf & _
           "Обработано генераторов: " & genCount, vbInformation, "Успех"
Else
    MsgBox "Внимание: Не найдено ни одного генератора с данными Delta!", vbExclamation, "Предупреждение"
End If

' --- Очистка ---
Set colName = Nothing
Set tbl = Nothing
Set wsResult = Nothing
Set wsData = Nothing
Set wb = Nothing
xl.DisplayAlerts = True
' xl.Quit ' Раскомментируйте, если нужно закрыть Excel автоматически
Set xl = Nothing
