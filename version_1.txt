' --- Подключение к Excel ---
Set xl = CreateObject("Excel.Application")
xl.Visible = True
xl.DisplayAlerts = False
Set wb = xl.Workbooks.Add
Set wsData = wb.Worksheets(1) ' Лист с исходными данными
wsData.Name = "Данные"
Set wsResult = wb.Worksheets.Add ' Лист с результатами
wsResult.Name = "Результаты"

' --- Заголовки результатов ---
wsResult.Cells(1, 1).Value = "Генератор"
wsResult.Cells(1, 2).Value = "Max Delta"
wsResult.Cells(1, 3).Value = "Min Delta"

' --- Получение таблицы генераторов ---
On Error Resume Next
Set tbl = Rastr.Tables("Generator")
If Err.Number <> 0 Then
    MsgBox "Ошибка: Таблица Generator не найдена!", vbCritical, "Ошибка"
    wb.Close False
    xl.Quit
    Set xl = Nothing
    WScript.Quit
End If
On Error GoTo 0

Set colName = tbl.Cols("Name")
If colName Is Nothing Then
    MsgBox "Ошибка: Колонка Name не найдена в таблице Generator!", vbCritical, "Ошибка"
    wb.Close False
    xl.Quit
    Set xl = Nothing
    WScript.Quit
End If

' --- Счетчик для результатов ---
Dim genCount: genCount = 0
Dim resultRow: resultRow = 2
Dim dataCol: dataCol = 1 ' Отдельный счетчик для колонок данных (начинаем с 1)

' --- Цикл: обработка генераторов и вычисление Max/Min ---
For i = 0 To tbl.Size - 1
    Dim genName: genName = colName.ZS(i)
    
    ' Получение графика (Double) и не используем Set!
    On Error Resume Next
    Dim Plot: Plot = Rastr.GetChainedGraphSnapshot("Generator", "Delta", i, 0)
    Dim errNum: errNum = Err.Number
    On Error GoTo 0
    
    If errNum = 0 And IsArray(Plot) Then
        ' --- Шаг 1: Запись данных в Excel (лист wsData) ---
        Dim npoints: npoints = UBound(Plot, 1) + 1 ' Количество точек
        
        If npoints > 0 Then
            ' --- Заголовки колонок (используем отдельный счетчик dataCol) ---
            Dim timeCol: timeCol = dataCol ' Колонка для Time
            Dim deltaCol: deltaCol = dataCol + 1 ' Колонка для Delta
            
            wsData.Cells(1, timeCol).Value = genName & " (Time)"
            wsData.Cells(1, deltaCol).Value = genName & " (Delta)"
            
            ' Запись массива данных построчно (Plot - это массив [npoints x 2])
            ' Одновременно вычисляем MAX и MIN для каждого генератора
            Dim j
            Dim maxDelta, minDelta, deltaVal
            Dim firstDelta: firstDelta = True
            
            For j = 0 To npoints - 1
                wsData.Cells(j + 2, timeCol).Value = Plot(j, 0) ' Time
                deltaVal = Plot(j, 1)
                wsData.Cells(j + 2, deltaCol).Value = deltaVal ' Delta
                
                ' Вычисляем MAX и MIN прямо здесь (надежнее чем формулы Excel)
                If firstDelta Then
                    maxDelta = deltaVal
                    minDelta = deltaVal
                    firstDelta = False
                Else
                    If deltaVal > maxDelta Then maxDelta = deltaVal
                    If deltaVal < minDelta Then minDelta = deltaVal
                End If
            Next
            
            ' --- Шаг 2: Записываем вычисленные MAX и MIN в wsResult ---
            wsResult.Cells(resultRow, 1).Value = genName
            wsResult.Cells(resultRow, 2).Value = maxDelta
            wsResult.Cells(resultRow, 3).Value = minDelta
            
            resultRow = resultRow + 1
            genCount = genCount + 1
            
            ' Увеличиваем счетчик колонок для следующего генератора (ПОСЛЕ использования deltaCol!)
            dataCol = dataCol + 2
        End If
    End If
Next

' --- Форматирование ---
wsData.Columns.AutoFit
wsResult.Columns.AutoFit

' --- Форматирование заголовков результатов ---
With wsResult.Range("A1:C1")
    .Font.Bold = True
    .Interior.Color = RGB(200, 200, 200)
End With

' --- Итоговое сообщение ---
If genCount > 0 Then
    MsgBox "Обработка завершена!" & vbCrLf & _
           "Обработано генераторов: " & genCount, vbInformation, "Успех"
Else
    MsgBox "Внимание: Не найдено ни одного генератора с данными Delta!", vbExclamation, "Предупреждение"
End If

' --- Очистка ---
Set colName = Nothing
Set tbl = Nothing
Set wsResult = Nothing
Set wsData = Nothing
Set wb = Nothing
xl.DisplayAlerts = True
' xl.Quit ' Раскомментируйте, если нужно закрыть Excel автоматически
Set xl = Nothing
